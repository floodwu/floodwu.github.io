# 切分查询

将大查询切分成小查询，以避免一个大的语句一次锁住很多数据、占满整个事务日志，如：

```
DELETE FROM messages WHERE created < DATA_SUB(NOW(),INTERVAL 3 MONTH);
```
可以如下优化：
```
rows_affected = 0
do{
  rows_affected = do_query('DELETE FROM messages WHERE created < DATA_SUB(NOW(),INTERVAL 3 MONTH) LIMIT 10000')  // 一次删除10000行
}while rows_affected > 0
```
每次删除数据后都暂停一下再做下一次删除，这样可以将服务器上原本一次性的压力分散到一个很长的时间段中，从而避免长时间持有锁。
## 使用上下文操作实现列表视图的多选操作

上下文操作是一种与某个特定屏幕视图而非整个屏幕相关联的操作，通过长按视图触发，例如删除列表中的某一项。在API11以下的设备上展示为一个浮动菜单，在较新的设备上通过上下文操作栏呈现。
在较新设备上长按视图进入上下文操作模式是提供上下文操作的主流方式，屏幕进入上下文操作模式时，上下文菜单中定义的菜单项出现并覆盖操作栏。相比浮动菜单，上下文操作栏不会遮挡屏幕，因而是更好的菜单展现方式。
列表视图进入上下文操作模式时，可开启它的多选模式。多选模式下，上下文操作栏上的任何操作都将同时应用于所有已选视图。

```java
public class CrimeListFragment extends ListFragment{
@TargetApi(11)
@Override
public View onCreateView(LayoutInflater inflater,ViewGroup parent,Bundle savedInstanceState){
View v = super.onCreateView(inflater,parent,savedInstanceState);
ListView listView = (ListView)v.findViewById(android.R.id.list);

// 设置列表视图的选择模式
listView.setChoiceMode(ListView.CHOICE_MODE_MULTIPLE_MODAL);  

// MutiChoiceModeListener实现了另一个接口：ActionMode.Callback，用户屏幕进入上下文操作模式时，会创建一个ActionMode实例，之后在其生命周期内Callback接口的回调方法会在不同时点被调用
listView.setMultiChoiceModelListener(new MultiChoiceModeListener(){ 

// 视图在选中，或撤销选中时触发
public void onItemCheckedStateChanged( 
ActionMode mode, int position, long id, boolean checked){
...
}

// 在ActionMode对象创建后调用，也是实例化上下文菜单资源，并显示在上下文操作栏上的任务完成的地方
public boolean onCreateActionMode(ActionMode mode, Menu menu){
// 注意这里是从ActionMode对象获取MenuInflater对象，而不是通过Activity对象来获得。ActionMode负责对上下文操作栏进行配置，比如设置标题等，Activity的MenuInflater做不到这一点。
MenuInflater inflater = mode.getMenuInflater();
inflater.inflate(R.menu.crime_list_item_context,menu); // 渲染菜单视图
return true;
}

// 在onCreateActionMode()方法之后，以及当前上下文操作栏需要刷新显示新数据时调用
public boolean onPrepareActionMode(ActionMode mode,Menu menu){
return false;
}

// 在用户选中某个菜单项操作时调用，是响应上下文菜单项操作的地方
public boolean onActionItemClicked(ActionMode mode,MenuItem item){
switch(item.getItemId()){
case R.id.menu_item_delete_crime:
CrimeAdapter adapter = (CrimeAdapter)getListAdapter();
CrimeLab crimeLab = CrimeLab.get(getActivity());
for(int i = adapter.getCount()-1; i>=0; i--){
// 多选模式，删除一个或多个Crime对象
if(getListView().isItemChecked(i)){
crimeLab.deleteCrime(adapter.getItem(i));
}
}
mode.finish();
adapter.notifyDataSetChanged();
return true;
default:
return false;
}
}

// 在用户退出上下文操作模式或所选菜单项操作已被响应，从而导致ActionMode对象将要销毁时调用
public void onDestroyActionMode(ActionMode mode){
..
}
});
return v;
}
```
以上通过使用MultiChioceModeListener接口的方式，会自动创建ActionMode实例。因此以上解决方案可应用于ListView或GridView。对于其他视图，要使用上下文操作栏，需要实现一个View.OnLongClickListener接口的监听器，然后在监听器实现中调用Activity.startActionMode(...)方法创建一个ActionMode实例。startActionMode(...)方法需要一个实现了ActionMode.Callback接口的对象作为参数，而该接口即包含了上述的各个回调方法。
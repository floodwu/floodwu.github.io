# 文件上传的安全问题

## 文件上传漏洞
文件上传漏洞指Web用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行Web服务器端命令的能力（即所谓的webshell）。要完成这个攻击需要满足以下条件：
1.上传的文件能够被Web容器解释执行；
2.用户能够从Web上访问这个文件；
3.用户上传的文件不能被安全检查、格式化、图片压缩等功能改变了内容；

在针对上传文件的检查中，很多应用都是通过判断文件名后缀的方法来验证。有时可以通过修改上传过程的POST包，在文件名后添加一个%00字节，则可以截断某些函数对文件名的判断，因为在很多语言中（C、PHP）0x00被认为是终止符。比如原本只允许上传jpg文件，那么可以构造文件名为xxx.php[\0].jpg,因为[\0]为16进制的0x00字符，.jpg绕过了应用的上传文件类型的判断，但是对于服务器来说，此文件因为0x00字符截断的关系，最终变成xxx.php。

有些应用通过判断上传文件的文件头信息来验证文件的类型，为了绕过应用中类似MIME Sniff的功能，常见的攻击技巧是伪造一个合法的文件头，而将真实的PHP等脚本代码附在合法的文件头之后。当然，这种情况下需要让Web Server将此文件当做PHP文件来解析才能实现攻击。

Apache、IIS等，旧版本中都有一些已知的文件路径解析的漏洞，详略。

## 利用上传文件钓鱼
通过伪造文件头的方式（比如伪造一个png文件），构造一个实际内容为JavaScript的图片，JavaScript中的代码重定向到钓鱼网站。这样，在传播钓鱼网站时可以传播合法的图片URL（域名合法），在低版本的浏览器中会将此文件当做HTML执行，从而将用户诱导到钓鱼网站。（现代浏览器不会将jpg当做HTML执行）

## 设计安全的文件上传功能
1.文件上传的目录设置为不可执行；
2.判断文件类型，对于图片处理可以使用压缩函数、resize函数等以破坏图片中可能存在的代码；
3.使用随机数改写文件名和文件路径；
4.单独设置文件服务器的域名；
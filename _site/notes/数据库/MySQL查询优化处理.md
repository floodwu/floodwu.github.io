# MySQL查询优化处理

查询优化处理的作用是将SQL转换成一个执行计划，MySQL会按照这个执行计划和存储引擎进行交互，这个过程包含多个子阶段：
1.语法解析器和预处理：通过关键字解析SQL语句，生成一个解析树，并进行语法验证。预处理器则会检查数据表和列是否存在，并验证权限。
2.查询优化器：一条查询可以有多种执行方式，优化器的作用是找到这其中最好的执行计划。优化基于`查询成本`来进行成本估算，可以如下查看查询成本：

```
SELECT SQL_NO_CACHE COUNT(*) FROM...;
SHOW STATUS LIKE 'Last_query_cost';  // 返回值表示优化器认为查询需要随机查找的页数
```
优化器的成本估算并不等于实际执行查询的成本，所以最终选择的不一定是最优执行计划。（比如优化器并不会考虑其他并发的查询）
MySQL能够执行的常见的优化包括：
（1）重新定义关联表的顺序；
（2）将外连接转化为内连接；
（3）使用等价变换规则，例如5=5 AND a>5会被改写为a>5
（4）优化COUNT()、MIN()、MAX()：如要找某一列的最小值，只要查询对应B-Tree索引最左端的记录
（5）预估并转化为常数表达式：当检测到一个表达式可以转化为常数时，就会一直把该表达式作为常数进行优化处理;
（6）覆盖索引扫描；
（7）子查询优化：转换子查询的形式，减少多个查询多次对数据进行访问；
（8）提前终止查询；如下查询在优化阶段就已经终止：
```
SELECT film.film_id FROM sakila.film WHERE film_id = -1;
```
（9）等值传播：如果两个列通过等式关联（USING），MySQL会把其中一个列的WHERE条件传递到另一个列上；
（10）对IN的优化；在MySQL中，IN列表中的数据会先进行排序，然后通过二分查找法确定列表中的值是否满足条件；而不是像其他DB那样转换为OR查询。
...
详略。

可以通过执行EXPLAIN EXTENDED之后再执行SHOW WARNINGS来查看重构出的查询。
# Redis底层实现-复制

可以通过执行SLAVEOF命令或者设置slaveof选项，让一个服务器去复制（replicate）另一个服务器。如：

```
127.0.0.1:12345> SLAVEOF 127.0.0.1 6379
OK
```
进行复制中的主从服务器双方的数据库将保存相同的数据。

## 旧版复制功能的实现
Redis的复制功能分为同步（sync）和命令传播（commandpropagate）两个操作。
1.同步：用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态。
当客户端向从服务器发送SLAVEOF命令，要求从服务器复制主服务器时，从服务器首先需要执行同步操作，将从服务器的数据库状态更新至主服务器当前所处的数据库状态。
具体方式是，主服务器执行BGSAVE生成rdb文件，同时启动缓冲区接收命令，然后将rdb文件传给从服务器，从服务器使用rdb进行同步，然后再执行缓冲区中剩余的命令。

2.命令传播：在执行同步后，当主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态。
主服务器会将自己执行的写命令，也即是造成主从服务器不一致的那条写命令，发送给从服务器执行，当从服务器执行了相同的写命令之后，主从服务器将再次回到一致状态。

## 旧版复制功能的缺陷
对于断线后重复制来说，旧版复制功能虽然也能让主从服务器重新回到一致状态（重新执行SYNC进行全量复制，而不是差量复制，即使只是瞬间断开），但效率却非常低。

## 新版复制功能的实现
Redis从2.8版本开始，使用PSYNC命令代替SYNC命令来执行复制时的同步操作。PSYNC命令具有完整重同步（full resynchronization）和部分重同步（partial resynchronization）两种模式：
1.完整重同步用于处理初次复制情况：完整重同步的执行步骤和SYNC命令的执行步骤基本一样，它们都是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓冲区里面的写命令来进行同步。
2.部分重同步用于处理断线后重复制情况：当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接收并执行这些写命令，就可以将数据库更新至主服务器当前所处的状态。

执行SYNC命令需要生成、传送和载入整个RDB文件，而部分重同步只需要将从服务器缺少的写命令发送给从服务器执行就可以了。

## 部分重同步的实现
部分重同步功能由以下三个部分构成：   
1.主服务器的复制偏移量（replication offset）和从服务器的复制偏移量。 
主服务器和从服务器会分别维护一个复制偏移量（记录发送、收到的字节数）。通过对比主从服务器的复制偏移量，程序可以很容易地知道主从服务器是否处于一致状态。
2.主服务器的复制积压缓冲区（replication backlog）。   
由主服务器维护的一个固定长度先进先出（FIFO）队列，默认大小为1MB。当主服务器进行命令传播时，它不仅会将写命令发送给所有从服务器，还会将写命令入队到复制积压缓冲区里面。
3.服务器的运行ID（run ID）。
每个Redis服务器，不论主服务器还是从服务，都会有自己的运行ID。主服务器会在第一次同步时将自己的ID发送给从服务器，而从服务器则会在断线重连时用其进行判断，如果主服务器ID不一致，则进行全量复制。


复制积压缓冲区的最小大小可以根据公式second*write_size_per_second来估算，其中second为从服务器断线后重新连接上主服务器所需的平均时间（以秒计算）。

## PSYNC命令的实现
从服务器在开始一次新的复制时将向主服务器发送PSYNC ? -1命令，主动请求主服务器进行完整重同步。

如果从服务器已经复制过某个主服务器，那么从服务器在开始一次新的复制时将向主服务器发送PSYNC [runid] [offset]命令：其中runid是上一次复制的主服务器的运行ID，而offset则是从服务器当前的复制偏移量，接收到这个命令的主服务器会通过这两个参数来判断应该对从服务器执行哪种同步操作。

详略。

## 复制的实现
具体步骤如下：
1.设置主服务器的地址和端口；
2.建立套接字连接；
3.发送PING命令（检查套接字的读写状态是否正常），主服务器应该返回`PONG`；
4.身份验证；
5.向主服务器发送从服务器的监听端口号；
6.同步(从服务器将向主服务器发送PSYNC命令)；
7.命令传播；

## 心跳检测
从服务器默认会以每秒一次的频率，向主服务器发送命令：
```
REPLCONF ACK [replication_offset]
```
主要有三个作用：
1.检测主从服务器的网络连接状态。   
2.辅助实现min-slaves选项（Redis的min-slaves-to-write和min-slaves-max-lag两个选项可以防止主服务器在不安全的情况下执行写命令）。
3.检测命令丢失。
详略。


# Redis底层实现-服务器端

## 命令请求的执行过程
1.当用户在客户端中键入一个命令请求时，客户端会将这个命令请求转换成协议格式，然后通过连接到服务器的套接字，将协议格式的命令请求发送给服务器；
2.服务器读取套接字中协议格式的命令请求，并将其保存到客户端状态的输入缓冲区里面。
3.对输入缓冲区中的命令请求进行分析，提取出命令请求中包含的命令参数，以及命令参数的个数，然后分别将参数和参数个数保存到客户端状态的argv属性和argc属性里面。（命令表使用的是大小写无关的查找算法）
4.调用命令执行器，执行客户端指定的命令。
5.要执行一些后续工作；（记日志、写AOF缓冲区、传播给从服务器等，取决于具体的配置）
6.将命令回复发送给客户端，清空客户端状态的输出缓冲区，为处理下一个命令请求做好准备；
7.当客户端接收到协议格式的命令回复之后，它会将这些回复转换成人类可读的格式，并打印给用户观看；

## serverCron函数
serverCron函数默认每隔100毫秒执行一次，这个函数负责管理服务器的资源，并保持服务器自身的良好运转。
1.更新服务器时间缓存；
2.更新LRU时钟；
3.更新服务器每秒执行命令次数；
4.更新服务器内存峰值记录；
5.处理SIGTERM信号；
6.管理客户端资源；
7.管理数据库资源；
8.执行被延迟的BGREWRITEAOF；
9.检查持久化操作的运行状态；
10.将AOF缓冲区中的内容写入AOF文件；
11.关闭异步客户端；
12.增加cronloops计数器的值；（记录了serverCron函数执行的次数）

## 初始化服务器
一个Redis服务器从启动到能够接受客户端的命令请求，需要经过一系列的初始化和设置过程：
1.初始化服务器状态结构（initServerConfig）：创建一个struct redisServer类型的实例变量server作为服务器的状态，并为结构中的各个属性设置默认值。
（1）设置服务器的运行ID。  
（2）设置服务器的默认运行频率。   
（3）设置服务器的默认配置文件路径。   
（4）设置服务器的运行架构。   
（5）设置服务器的默认端口号。   
（6）设置服务器的默认RDB持久化条件和AOF持久化条件。   
（7）初始化服务器的LRU时钟。   
（8）创建命令表。
2.载入配置选项：在启动服务器时，用户可以通过给定配置参数或者指定配置文件来修改服务器的默认配置。
3.初始化服务器数据结构（initServer）：
（1）server.clients链表；
（2）server.db数组；
（3）用于保存频道订阅信息的server.pubsub_channels字典，以及用于保存模式订阅信息的server.pubsub_patterns链表。
（4）用于执行Lua脚本的Lua环境server.lua。
（5）用于保存慢查询日志的server.slowlog属性。
4.为服务器设置进程信号处理器。
5.创建共享对象：这些对象包含Redis服务器经常用到的一些值，比如包含"OK"回复的字符串对象，包含"ERR"回复的字符串对象，包含整数1到10000的字符串对象等等；
6.打开服务器的监听端口，并为监听套接字关联连接应答事件处理器，等待服务器正式运行时接受客户端的连接。
7.为serverCron函数创建时间事件，等待服务器正式运行时执行serverCron函数。
8.如果AOF持久化功能已经打开，那么打开现有的AOF文件，如果AOF文件不存在，那么创建并打开一个新的AOF文件，为AOF写入做好准备。
9.初始化服务器的后台I/O模块（bio），为将来的I/O操作做好准备。
10.服务器将用ASCII字符在日志中打印出Redis的图标，以及Redis的版本号信息；

## 还原数据库状态
在完成了对服务器状态server变量的初始化之后，服务器需要载入RDB文件或者AOF文件，并根据文件记录的内容来还原服务器的数据库状态。如果服务器启用了AOF持久化功能，那么服务器使用AOF文件来还原数据库状态。如果服务器没有启用AOF持久化功能，那么服务器使用RDB文件来还原数据库状态。
```
[5244] 21 Nov 22:43:49.084 * DB loaded from disk: 0.068 seconds
```

## 执行事件循环
```
[5244] 21 Nov 22:43:49.084 * The server is now ready to accept connections on port 6379
```
服务器现在开始可以接受客户端的连接请求，并处理客户端发来的命令请求了。
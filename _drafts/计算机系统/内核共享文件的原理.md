# 内核共享文件的原理

内核用3个相关的数据来表示打开的文件：
1.文件描述符表：每个进程都有自己的文件描述符表，表项为进程打开的文件描述符，每个文件描述符指向文件表中的一项；
2.文件表：打开文件的集合用文件表描述，所有进程共享这张表。每个文件表项包括有文件当前位置、引用计数、一个指向v-node表中对应表项的指针。关闭一个文件描述符会减少相应的文件表表项中的引用计数，内核会在引用计数为0时删除这个表项；
3.v-node表：每个表项包含stat结构中的大多数信息，包括st_mode、st_size等，所有进程共享这张表；

多个描述符可以通过不同的文件表表项来引用同一个文件，如以同一个filename来调用open两次。每个描述符都有它自己的当前位置，所以对不同描述符的读操作可以从文件的不同位置获取数据。
在调用了fork之后，子进程有一个父进程描述符表的副本，因此父子进程共享相同的文件表集合，从而共享相同的文件位置。
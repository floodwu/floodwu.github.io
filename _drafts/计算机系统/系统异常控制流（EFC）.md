# 系统异常控制流（EFC）

程序除了应该对由程序变量表示的内部程序状态中的变化做出反应，还必须对系统状态的变化做出反应。比如一个硬件定时器产生的信号、新的包到达网络适配器、子进程终止等等。系统使用异常控制流（EFC）来处理，异常控制流发生在计算机系统的各个层次：
在硬件层，硬件检测到的事件会触发控制突然转移到异常处理程序；
在操作系统层，内核通过上下文切换将控制从一个用户进程转移到另一个用户进程；
在应用层，一个进程可以发出信号到另一个进程，而接收者会将控制转移到它的一个信号处理程序；
一个程序可以通过回避通常的栈规则，并执行到其他函数中任意位置的非本地跳转来对错误做出反应。

EFC是操作系统用来实现I/O、进程和虚拟存储器的基本机制。
应用程序通过陷阱（trap）或者系统调用（system call）的EFC形式向操作系统请求服务，操作系统为应用程序提供了强大的EFC机制。
EFC是计算机系统中实现并发的基本机制。
有些高级编程语言中提供try、catch、throw语句来实现软件异常机制，允许程序进行非本地跳转，即违反通常的调用/返回栈规则的跳转来响应错误情况，这其实属于一种应用层ECF，在C中是通过setjmp和longjmp函数提供的。

## 异常
在处理器中状态被编码为不同的位和信号，状态变化称为事件。事件可能和当前指令的执行直接相关，也可能无关。在任何情况下，当处理器检测到有事件发生时，就会通过一张名为异常表的跳转表进行一个间接的过程调用，即调用一个专门设计用来处理这类事件的操作系统子程序（异常处理程序）。

根据异常事件的类型，当异常处理程序完成处理后会发生以下三种情况中的一种：
1.处理程序将控制返回给当前指令；
2.处理程序将控制返回给当前指令的下一条指令；
3.处理程序终止被中断的程序；

系统中给可能的每种类型的异常都分配了一个异常号，其中一些是由处理器分配的（除零、存储器访问违例、断点），其他的是由操作系统内核分配的。当系统启动时，操作系统分配和初始化异常表，其中每个条目包含指定异常的处理程序的地址。异常表的起始地址放在异常表基址寄存器（CPU中的特殊寄存器）中。

## 异常处理
异常处理类似于过程调用，但又有一些不同之处：
1.过程调用在跳转到处理程序之前，处理器会将返回地址压入栈中，而异常的返回地址则会根据类型可能是当前指令，也可能是下一条指令。
2.处理器会把处理器状态压到用户栈里以便在处理程序返回时重新开始被中断的程序。如果异常控制从一个用户程序转移到内核，那么所有这些项目都被压到内核栈中，而不是压到用户栈中。
3.异常处理程序运行在内核模式下，因此它们对所有的系统资源都有完全的访问权限。

一旦硬件触发了异常，剩下的工作就由异常处理程序在软件中完成，在处理程序处理完事件之后，它通过执行一条特殊的“从中断返回”指令，可选地返回到被中断的程序，该指令将适当的状态弹回到处理器的控制和数据寄存器中，如果异常中断的是一个用户程序，就将状态恢复为用户模式，然后将控制返回给被中断的程序。

## 异常有4种类别
1.中断：异步发生，是来自处理器外部的I/O设备的信号的结果，不是由任何专门的指令造成的。总是返回到下一条指令。I/O设备通过向处理器芯片上的一个引脚发信号，并将异常号（标识了引起中断的设备）放到系统总线上来触发中断。
2.陷阱：同步发生，属于有意的异常，是执行一条指令的结果，返回到下一条指令。主要用来提供系统调用。
3.故障：同步发生，由错误情况引起（比如缺页异常），如果处理程序能够修正这个错误情况，它就将控制返回到引起故障的指令，从而重新执行它，否则处理程序返回到内核中的abort例程，进而终止引起故障的应用程序。
4.终止：同步发生，不可恢复的致命错误造成的结果，通常是一些硬件错误。处理程序会将控制返回给一个abort例程，进而终止引起故障的应用程序。

IA32系统提供了256种不同的异常和上百种系统调用，详略。
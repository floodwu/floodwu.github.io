<!DOCTYPE html><html lang="en"><title>MySQL 常见的开放性问题</title><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, user-scalable=no"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover,minimum-scale=1.0, maximum-scale=1"><title>老王/张建的专栏</title><meta name="description" content="GitChat 是一款基于微信平台的知识分享产品。通过这款产品我们希望改变IT知识的学习方式。"><meta name="robots" content="index,follow"><meta name="keywords" content="GitChat,机器学习,大数据,程序员,用户体验,软件开发,知识付费,技术分享"><meta http-equiv="cache-control" content="max-age=0"><meta http-equiv="cache-control" content="no-cache"><meta http-equiv="expires" content="0"><meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv="pragma" content="no-cache"><meta name="baidu-site-verification" content="BRkuL6TTfM"><script src="/dist/site/gitchat/js1.js"></script><link href="/dist/css/bootstrap-toggle.min.css" rel="stylesheet"><link href="/dist/site/gitchat/bundle2.css" rel="stylesheet"><link rel="stylesheet" href="/css/gitchat/common/common.css"><script src="/dist/gitchat/js/common.js"></script><link rel="icon" type="image/png" href="https://images.gitbook.cn/FrfR1mB39xM-U6iSAmDCpxWVxvoa?imageslim" sizes="16x16"><link rel="icon" type="image/png" href="https://images.gitbook.cn/FrfR1mB39xM-U6iSAmDCpxWVxvoa?imageslim" sizes="32x32"></head><meta name="viewport" content="width=device-width, user-scalable=yes"><link href="/dist/gitchat/css/rpi.css" rel="stylesheet"><link href="/dist/gitchat/css/katex.min.css" rel="stylesheet"><script src="/dist/site/gitchat/js3.js"></script><script src="/dist/gitchat/js/columnRpi.js"></script><link href="/dist/site/gitchat/bundle1.css" rel="stylesheet"><link href="/css/gitchat/columnTopicDetail.css" rel="stylesheet"><link href="/dist/gitchat/css/columnListTemplate.css" rel="stylesheet"><link href="/dist/gitchat/css/readerGroupTemplate.css" rel="stylesheet"><body><input style="display:none;" id="refreshed" value="no"><script>var e = document.getElementById("refreshed");
if (e.value == "no") e.value = "yes";
else {
    e.value = "no";
    location.reload();
}</script><link rel="stylesheet" href="/css/gitchat/appBanner.css"><div class="app_banner"><div class="inner_banner"><img src="https://images.gitbook.cn/FiemqiGW5K9uxM-cSQWlrpiRP8Ua?imageslim" class="app_bg"><img id="downApp" src="https://images.gitbook.cn/Fg1FfEczUbS2nF4p2LT_erPD6d9I" class="app_btn"><span id="closeApp" class="app_close">×</span></div></div><script>var showStatus = true;
$('#downApp').on('click',function(){
    window.location.href = 'http://app.gitbook.cn/page/download?M_courcebanner';
    return false;
})
$('#closeApp').on('click',function(){
    $('.app_banner').fadeOut();
    showStatus = false;
    return false;
})
window.onscroll=function(){
    if(showStatus && $(document).scrollTop()>$('.app_banner').height()){
        $('.app_banner').fadeIn();
    }else{
        $('.app_banner').fadeOut();
    }
}</script><progress value="0" id="progressBar"><div class="progress-container"><span class="progress-bar"></span></div></progress><div id="topicContainer" class="topicContainer"><div class="no-mathjax topicTitle">MySQL 常见的开放性问题</div><article id="articleDiv" style="overflow: hidden;padding-bottom:15px;text-align: justify;"><div class="mazi-article-content dont-break-out"><h3 id="">有一个超级大表，如何优化分页查询？</h3>
<p>超级大表的分页优化分有以下两种方式：</p>
<ul>
<li>数据库层面优化：利用子查询优化超多分页场景，比如：<code>SELECT a.* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id=b.id</code> ，先快速定位需要获取的 id 段，然后再关联查询。MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前 offset 行，返回 N 行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行 SQL 改写，利用子查询先快速定位需要获取的 id 段，然后再关联查询，就是对分页进行 SQL 改写的具体实现；</li>
<li>程序层面优化：可以利用缓存把查询的结果缓存起来，这样再下一次查询的时候性能就非常高了。</li>
</ul>
<h3 id="-1">线上修改表结构有哪些风险？</h3>
<p>线上修改表结构有可能 MySQL 服务器阻塞，因为在执行 DML（select、update、delete、insert）操作时，会给表增加一个元数据锁，这个元数据锁是为了保证在查询期间表结构不会被修改，而执行修改表结构时，必须要等待元数据锁完成之后才能执行，这就可能造成数据库服务器的阻塞。</p>
<p>在 MySQL 5.6 开始提供了 online ddl 功能，允许一些 DDL（create table/view/index/syn/cluster）语句和 DML 语句并发，在 5.7 版本对 online ddl 又有了增强，这使得大部分 DDL 操作可以在线进行，详见：https://dev.mysql.com/doc/refman/5.7/en/innodb-create-index-overview.html，这使得在线上修改表结构的风险变的更大，如果在业务开发过程中必须在线修改表结构，可以参考以下方案：</p>
<ul>
<li>尽量在业务量小的时间段进行；</li>
<li>查看官方文档，确认要做的表修改可以和 DML 并发，不会阻塞线上业务；</li>
<li>推荐使用 percona 公司的 pt-online-schema-change 工具，该工具被官方的 online ddl 更为强大，它的基本原理是：通过 insert...select... 语句进行一次全量拷贝，通过触发器记录表结构变更过程中产生的增量，从而达到表结构变更的目的。比如，要对 A 表进行变更，它的主要流程为：</li>
</ul>
<p>1）创建目的表结构的空表 A_new；</p>
<p>2）在A表上创建触发器，包括增、删、改触发器；</p>
<p>3）通过 insert...select...limit N 语句分片拷贝数据到目的表；</p>
<p>4）Copy完成后，将 A_new 表 rename 到 A 表。</p>
<h3 id="-2">查询长时间不返回可能是什么原因？应该如何处理？</h3>
<p>查询速度慢的原因很多，常见如下几种：
1）查询字段没有索引或者没有触发索引查询，没有触发索引查询的情况如下：
不会使用索引的情况如下：</p>
<ul>
<li>以 % 开头的 like 查询不会使用 b-tree 索引；</li>
<li>数据类型出现隐式转换时不会使用索引，比如，某列是 varchar 类型，却使用了column<em>name=1 的查询语句，这是不会使用索引，正确触发索引的查询语句为：column</em>name='1' ；</li>
<li>不符合最左前缀原则；</li>
<li>如果查询条件有 or 分割，or 前面的使用索引，or 后面的未使用索引，则不会使用索引，因为即使 or 之前的使用了索引，但是 or 之后的也需要全表查询，索引就忽略索引，直接全表查询；</li>
<li>如果 MySQL 认为使用索引会比全表查询更慢，则不会使用索引。</li>
</ul>
<p>2）I/O 压力大，读取磁盘速度变慢。
3）内存不足
4）网络速度慢
5）查询出的数据量过大，可以采用多次查询或其他的方法降低数据量
6）死锁，一般碰到这种情况的话，大概率是表被锁住了，可以使用 <code>show processlist;</code> 命令，看看 SQL 语句的状态，再针对不同的状态做相应的处理。</p>
<p><img src="https://images.gitbook.cn/Fi_vowvU742l_3FU1gjmBCnhYLZD" alt="avatar" /></p>
<p>其中，当 State 列值为 Locked 时，表示被锁定。
其它关于查看死锁的命令：
a）查看当前的事务：</p>
<blockquote>
  <p>select * from information<em>schema.innodb</em>trx;</p>
</blockquote>
<p>b）查看当前锁定的事务：</p>
<blockquote>
  <p>select * from information<em>schema.innodb</em>locks;</p>
</blockquote>
<p>c）查看当前等锁的事务</p>
<blockquote>
  <p>select * from information<em>schema.innodb</em>lock_waits;</p>
</blockquote>
<p>以上问题的解决方案如下：</p>
<p>1）正确创建和使用索引。
2）把数据、日志、索引放到不同的 IO 设备上，减少主数据库的 IO 操作。更换 MySQL 的磁盘为固态硬盘，以提高磁盘的 IO 性能。
3）升级内存，更换更大的内存。
4）提升网速，升级带宽。
5）用 Profiler 来跟踪查询，得到查询所需的时间，找出有问题的 SQL 语句，优化 SQL。
6）查询时值返回需要的字段。
7）设置死锁的超时时间，限制和避免死锁消耗过多服务器的资源。
8）尽量少用视图，它的效率低，对视图操作比直接对表操作慢,可以用存储过程来代替视图。不要用视图嵌套，嵌套视图增加了寻找原始数据的难度。</p>
<h3 id="mysql">MySQL 主从延迟的原因有哪些？</h3>
<p>主从延迟可以根据 MySQL 提供的命令判断，比如，在从服务器使用命令： <code>show slave status;</code>，其中 Seconds<em>Behind</em>Master 如果为 0 表示主从复制状态正常。
导致主从延迟的原因有以下几个：</p>
<ul>
<li>主库有大事务处理；</li>
<li>主库做大量的增、删、改操作；</li>
<li>主库对大表进行字段新增、修改或添加索引等操作；</li>
<li>主库的从库太多，导致复制延迟。从库数量一般 3-5 个为宜，要复制的节点过多，导致复制延迟；</li>
<li>从库硬件配置比主库差，导致延迟。查看 Master 和 Slave 的配置，可能因为从库的配置过低，执行时间长，由此导致的复制延迟时间长；</li>
<li>主库读写压力大，导致复制延迟；</li>
<li>从库之间的网络延迟。主从库网卡、网线、连接的交换机等网络设备都可能成为复制的瓶颈，导致复制延迟，另外跨公网主从复制很容易导致主从复制延迟。</li>
</ul>
<h3 id="-3">如何保证数据不被误删？</h3>
<p>保证数据不被误删的方法如下列表：</p>
<ul>
<li>权限控制与分配（数据库和服务器权限）</li>
<li>避免数据库账号信息泄露，在生产环境中，业务代码不要使用明文保存数据库连接信息；</li>
<li>重要的数据库操作，通过平台型工具自动实施，减少人工操作；</li>
<li>部署延迟复制从库，万一误删除时用于数据回档，且从库设置为 read-only；</li>
<li>确认备份制度及时有效；</li>
<li>启用 SQL 审计功能，养成良好 SQL 习惯；</li>
<li>启用 sql<em>safe</em>updates 选项，不允许没 where 条件的更新/删除；</li>
<li>将系统层的 rm 改为 mv；</li>
<li>线上不进行物理删除，改为逻辑删除（将 row data 标记为不可用）；</li>
<li>启用堡垒机，屏蔽高危 SQL；</li>
<li>降低数据库中普通账号的权限级别；</li>
<li>开启 binlog，方便追溯数据。</li>
</ul>
<h3 id="mysqlcpu">MySQL 服务器 CPU 飙升应该如何处理？</h3>
<p>使用 <code>show full processlist;</code> 查出慢查询，为了缓解数据库服务器压力，先使用 kill 命令杀掉慢查询的客户端，效果如下：</p>
<p><img src="https://images.gitbook.cn/Fv6SAcc3e6TTvbMaSfe7OgGc_0Md" alt="avatar" /></p>
<p>然后再去项目中找到执行慢的 SQL 语句进行修改和优化。</p>
<h3 id="mysql-1">MySQL 毫无规律的异常重启，可能产生的原因是什么？该如何解决？</h3>
<p>可能是积累的长连接导致内存占用太多，被系统强行杀掉导致的异常重启，因为在 MySQL 中长连接在执行过程中使用的临时内存对象，只有在连接断开的时候才会释放，这就会导致内存不断飙升，解决方案如下：</p>
<ul>
<li>定期断开空闲的长连接；</li>
<li>如果是用的是 MySQL 5.7 以上的版本，可以定期执行 mysql<em>reset</em>connection 重新初始化连接资源，这个过程会释放之前使用的内存资源，恢复到连接刚初始化的状态。</li>
</ul>
<h3 id="-4">如何实现一个高并发的系统？</h3>
<p>这道面试题涉及的知识点比较多，主要考察的是面试者的综合技术能力。高并发系统的设计手段有很多，主要体现在以下五个方面。</p>
<h4 id="1">1）前端优化</h4>
<p>① 静态资源缓存：将活动页面上的所有可以静态的元素全部静态化，尽量减少动态元素；通过 CDN、浏览器缓存，来减少客户端向服务器端的数据请求。
② 禁止重复提交：用户提交之后按钮置灰，禁止重复提交。
③ 用户限流：在某一时间段内只允许用户提交一次请求，比如，采取 IP 限流。</p>
<h4 id="2">2）中间层负载分发</h4>
<p>可利用负载均衡，比如 nginx 等工具，可以将并发请求分配到不同的服务器，从而提高了系统处理并发的能力。
nginx 负载分发的五种方式：</p>
<p>① 轮询（默认）
每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器不能正常响应，nginx 能自动剔除故障服务器。
② 按权重（weight）
使用 weight 参数，指定轮询几率，weight 和访问比率成正比，用于后端服务器性能不均的情况，配置如下：</p>
<pre><code class="xml language-xml">upstream backend { 
    server 192.168.0.14 weight=10; 
    server 192.168.0.15 weight=10; 
}
</code></pre>
<p>③ IP 哈希值（ip_hash）
每个请求按访问 IP 的哈希值分配，这样每个访客固定访问一个后端服务器，可以解决 session 共享的问题，配置如下：</p>
<pre><code class="xml language-xml">upstream backend { 
    ip_hash; 
    server 192.168.0.14:88; 
    server 192.168.0.15:80; 
}
</code></pre>
<p>④ 响应时间（fair）
按后端服务器的响应时间来分配请求，响应时间短的优先分配，配置如下：</p>
<pre><code class="xml language-xml">upstream backend { 
    fair; 
    server server1.com; 
    server server2.com; 
}
</code></pre>
<p>⑤ URL 哈希值（url_hash）
按访问 url 的 hash 结果来分配请求，和 IP 哈希值类似。</p>
<pre><code class="xml language-xml">upstream backend {
    hash $request_uri;
    server server1.com; 
    server server2.com;   
}
</code></pre>
<h4 id="3">3）控制层（网关层）</h4>
<p>限制同一个用户的访问频率，限制访问次数，防止多次恶意请求。</p>
<h4 id="4">4）服务层</h4>
<p>① 业务服务器分离：比如，将秒杀业务系统和其他业务分离，单独放在高配服务器上，可以集中资源对访问请求抗压。
② 采用 MQ（消息队列）缓存请求：MQ 具有削峰填谷的作用，可以把客户端的请求先导流到 MQ，程序在从 MQ 中进行消费（执行请求），这样可以避免短时间内大量请求，导致服务器程序无法响应的问题。
③ 利用缓存应对读请求，比如，使用 Redis 等缓存，利用 Redis 可以分担数据库很大一部分压力。</p>
<h4 id="5">5）数据库层</h4>
<p>① 合理使用数据库引擎
② 合理设置事务隔离级别，合理使用事务
③ 正确使用 SQL 语句和查询索引
④ 合理分库分表
⑤ 使用数据库中间件实现数据库读写分离
⑥ 设置数据库主从读写分离</p></div></article><div id="writeCommentDiv" style="margin-top: 10px;display:none;"><div class="col-xs-12 comment-btn-div"><button onclick="redirectSubmitPage(&quot;null&quot;,&quot;true&quot;)" class="mazi-comment-btn">写评论</button></div></div><div style="display:none;" class="topicComments"><div id="topicComments" topicid="5d80b48749b2b1063b529961" comment-num="0" columnId="5d80aea449b2b1063b52990f"></div></div><div id="hasSubscription"></div><div id="commentModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" data-dismiss="modal" aria-label="Close" class="close"><span aria-hidden="true">&times;</span></button><h4 style="text-align:center;margin:0;">文章评论</h4></div><div style="padding-bottom:10;" class="modal-body"><div class="row"><div style="text-align:right" class="col-xs-12"><textarea id="topicComment" rows="7" style="width:100%;border:1px solid #cccccc;-webkit-appearance:none;"></textarea><span id="tip">0/200</span></div></div></div><div class="modal-footer"><button id="topicSubmitBtn" disabled="disabled" style="width:100%" class="btn btn-primary">提交</button></div></div></div></div><script>function showTip() {
    $('#pdfTips').modal('show')
}
function openPdf(){
    window.location.href = '';
}</script><div class="split_line"></div><div class="topic_item"><div class="topic-cell"><div class="wrapper"><div class="userInfo"><div class="avatorWrapper"><img src="https://images.gitbook.cn/663e5710-b748-11e8-b809-d915783fbfe8?imageView2/2/h/50" width="20" height="20" class="header_img"></div><div class="feedInfo"><div class="userName">torres</div></div><div class="feedTime">2019-09-28 13:50</div></div><div class="feedContent"><div class="talkContent"><div class="text talk_detail"><span style="display: block;overflow: hidden" class="topic_text">赞，深度好文</span><div class="clearfix"></div></div></div></div></div></div><div class="topic-cell"><div class="wrapper"><div class="userInfo"><div class="avatorWrapper"><img src="https://images.gitbook.cn/98b860c0-952c-11e8-b8b3-690dce6077c1?imageView2/2/h/50" width="20" height="20" class="header_img"><img src="http://images.gitbook.cn/cvip.png" height="30" width="30" class="vIcon"></div><div class="feedInfo"><div class="userName">老王</div></div><div class="feedTime">2019-09-26 23:19</div></div><div class="feedContent"><div class="qaContent"><div class="answerText">group by 在满足条件的情况下会走索引，比如，select tid from t where tid&amp;gt;10 group by tid，当 where 和 group by 都是同样的字段时，就会走索引。</div><div class="text question_view"><span class="questioner">______Wm提问：</span><span>请问group by走索引吗</span></div></div><div class="comment"><ul><li class="contentWrapper"><div><span class="userName">______Wm</span><div class="commentContent">谢谢</div></div></li></ul></div></div></div></div></div><a style="" href="/chatGroup.html#/groups/5b55849bc28306099b47ae7d" data-toggle="modal" data-target="" class="reader_btn">查看更多</a><div class="detail_bottom"><div class="detail_bottom_menu"><a href="/m/mazi/comp/column?columnId=5d80aea449b2b1063b52990f&amp;tag=2#catalog" class="detail_catalog_2"><img src="https://images.gitbook.cn/FoNYstI_LM90qvSH1CcqIPRPXi93"></a><a href="/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b43b49b2b1063b52995f" class="detail_bottom_left"><img src="https://images.gitbook.cn/FtV6I5EsuprXLmIzsQ89j-7QfsNa" class="arrow_image"></a><a class="detail_bottom_right"><img src="https://images.gitbook.cn/Fm-Vws-c2_3zb69x8FAs2O0I3D7f" class="arrow_image"></a><a href="/chatGroup.html#/groups/5b55849bc28306099b47ae7d" style="" class="detail_readers"><img src="https://images.gitbook.cn/FjM1UjGTLGkqf-VqNqnGWuQUZo-H"></a></div></div></div><div id="inviteCardModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" style="margin:0 auto;padding:10px 10px 0;" class="modal-dialog"><div style="background:#fcfcfc" class="modal-content"><div style="text-align:center;padding:10px;background:#fff;border:none;" class="modal-header"><h4 id="inviteCardModalLabel" style="font-size:16px;font-weight:700;color: #3f3f3f;text-align: center;" class="modal-title">长按图片分享或保存</h4></div><div style="padding:0;line-height:30px;overflow:auto;-webkit-overflow-scrolling: touch;" class="modal-body"><div id="inviteCardLoader" style="text-align:center;height:200px;"><div style="margin-top:140px;"><img style="width:50px;" src="https://images.gitbook.cn/loading_spinner.gif"></div><div style="color:#ccc;">正在生成图片...</div></div><div id="inviteCardbody" style="text-align:center;display:none;height:320px;min-height:320px;"><img id="inviteCardImg" style="width:100%"></div></div><div style="text-align:center;padding:10px;background:rgba(255,255,255,0.9);" class="modal-footer"><div style="font-size:12px;color:#333;">用专属海报每邀请一位好友购买，即可获得原价的 1/4 作为奖励。上不封顶，立即提现。您可以在「我-我的邀请奖励」中查看邀请详情并进行提现。</div><a style="font-size:14px;color:#FF700A;background:#FDF2E0;border-radius:20px;margin:10px auto 0;display:inline-block;text-align:center;padding:6px 15px;" href="/m/mazi/statistic/invites/column/5d80aea449b2b1063b52990f">查看分享达人排行        </a></div></div><div style="background:rgba(0,0,0,0);text-align:center;" class="modal-colse"><img data-dismiss="modal" aria-label="Close" style="width:50px;" src="https://images.gitbook.cn/FvFDp80XHoLkvq8pNhBm3CWUWW4r"></div></div></div><div id="showInviteCardTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 style="text-align:center;" class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">成功购买本专栏，即可获得专属返利海报！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="showTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div style="text-align:center;" class="modal-header"><h4 class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">快去预订吧！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="showVIPBuyModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 style="text-align:center;" class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div id="showVIPBuyText" style="text-align:center;"></div></div><div style="margin-top: 10px;text-align:center;" class="modal-footer"><a href="/m/mazi/comp/column?columnId=5d80aea449b2b1063b52990f" class="btn btn-primary">知道了</a></div></div></div></div><div id="showNotFinishedTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div style="text-align:center;" class="modal-header"><h4 class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">作者正在写作中，请耐心等待！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="showNeedBuyTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" data-dismiss="modal" class="modal-dialog"><div class="modal-content"><div style="text-align:center;" class="modal-header"><h4 class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">购买本专栏，即可继续阅读文章！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="appClick" style="display:none" data-toggle="modal" data-target="#appModal"></div><div id="appModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-body"><img src="https://images.gitbook.cn/FmmfLbTAH8_vkKHDDvzCOXFGxTa_"><div class="app_btns"><a href="http://app.gitbook.cn/page/download" class="download_btn"></a><div data-dismiss="modal" class="close_btn">果断拒绝</div></div></div></div></div></div></body><script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script><script>$.ajax ({
    url: "/weixin/signature",
    type: "POST",
    data: JSON.stringify({url:window.location.href}),
    dataType: "json",
    contentType: "application/json; charset=utf-8",
    success: function(data,status){
        if(data.code == 0){
            wx.config({
            debug: false,
            appId: 'wx7ba47eadabd9ddde',
            timestamp: data.timestamp,
            nonceStr: data.nonce,
            signature: data.sha1,
            jsApiList: ['onMenuShareTimeline','onMenuShareAppMessage','onMenuShareQQ','onMenuShareWeibo','onMenuShareQZone','chooseWXPay']
            });
            wx.ready(function(){
                //alert('config check successfully.');
                wx.onMenuShareTimeline({
                title: 'MySQL 常见的开放性问题 | 老王/张建', // 分享标题
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b48749b2b1063b529961?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType:'', // activity, article, author, others
                            shareItemId:'',
                            shareToken:'',
                            shareChanel:'weixinTimeline',
                            shareItemUrl:window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareAppMessage({
                title: 'MySQL 常见的开放性问题 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b48749b2b1063b529961?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                type: 'link', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function () {
                    // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType: '', // activity, article, author, others
                            shareItemId: '',
                            shareToken: '',
                            shareChanel: 'weixinMessage',
                            shareItemUrl: window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareQQ({
                title: 'MySQL 常见的开放性问题 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b48749b2b1063b529961?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType: '', // activity, article, author, others
                            shareItemId: '',
                            shareToken: '',
                            shareChanel: 'qq',
                            shareItemUrl: window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareWeibo({
                title: 'MySQL 常见的开放性问题 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b48749b2b1063b529961?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareQZone({
                title: 'MySQL 常见的开放性问题 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b48749b2b1063b529961?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType: '', // activity, article, author, others
                            shareItemId: '',
                            shareToken: '',
                            shareChanel: 'QZone',
                            shareItemUrl: window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
            });
            wx.error(function (res) {
            });
        }
    }
});</script><script type="text/x-mathjax-config">MathJax.Hub.Config({messageStyle: "none",CommonHTML: {linebreaks: {automatic: true}},tex2jax: {inlineMath: [['$$','$$'],['$','$'], ['\\(','\\)']], processClass: "mathjax",ignoreClass: "no-mathjax"}});</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script><script>hljs.initHighlightingOnLoad();
$(function(){
    var columnId = '5d80aea449b2b1063b52990f';
})
wx.ready(function() {
    var audio = document.getElementById("audio");
    if (audio) {
        audioConfig()
    }

});
function backToDetail(id){
    window.location.href=`/m/mazi/comp/column?columnId=${id}`;
}
$("#control").click(function() {
    var audio = document.getElementById("audio");
    if ($("#control").hasClass("play")) {
        $("#control").addClass("pause").removeClass("play");
        audio.play();//开始播放
    } else {
        $("#control").addClass("play").removeClass("pause");
        audio.pause();
    }
})
function getColumnInviteCard(columnId){
    $('#inviteCardModal').modal('show');
    var requestUrl = encodeURI(window.location.href);
    $.ajax({
        url: "/m/mazi/columnInviteCard/" + columnId,
        type: "POST",
        data: JSON.stringify({requestUrl: requestUrl}),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data, status) {
            if (status == 'success' && data.code == 0) {
                $('#inviteCardLoader').hide();
                $('#inviteCardbody').show();
                $('#inviteCardImg').attr('src', data.imgUrl);
            } else if (data.code == -1 && data.redirectUrl && data.redirectUrl != '') {
                $('#inviteCardModal').modal('hide');
                window.location.href = data.redirectUrl + '?err=' + data.message;
            } else {
                $('#inviteCardModal').modal('hide');
                alert(JSON.stringify(data.message));
            }
        }
    });
}

function getColumnInviteCardTip(columnId){
    $('#showInviteCardTipsModal').modal('show');
}
function audioConfig() {
    var audio = document.getElementById("audio");
    $("#control").addClass("play")
    audio.loop = true; //歌曲循环
    console.log('audio.duration', audio.duration)
    if (audio.duration) {
        var minute =  parseInt(audio.duration/60) 
        var second = parseInt(Math.round(audio.duration%60))
        if (second < 10) second = `0${second}` 
        if (minute < 10) minute = `0${minute}` 
        $("#allTime").html(`${minute}′${second}′′`);
    }
    audio.addEventListener("loadeddata", //歌曲一经完整的加载完毕( 也可以写成上面提到的那些事件类型)
    function() {
        var minute =  parseInt(audio.duration/60) 
        var second = parseInt(Math.round(audio.duration%60))
        if (second < 10) second = `0${second}` 
        if (minute < 10) minute = `0${minute}` 
        $("#allTime").html(`${minute}′${second}′′`);
        // 按钮
    }, false);

    audio.addEventListener("pause",
        function() { //监听暂停
            $("#control").addClass("play").removeClass("pause");
            if (audio.currentTime == audio.duration) {
                audio.stop();
                audio.currentTime = 0;
            }
        }, false);
    audio.addEventListener("play",
        function() { //监听暂停
            $("#control").addClass("pause").removeClass("play");
        }, false);
    audio.addEventListener("ended", function() {
        alert(0)
    }, false)
}</script><!--script.$(document).ready(function () {
    // 专题提交按钮
    $('#topicSubmitBtn').click(function () {
        var comment = $('#topicComment').val();
        var commentId = $('#topicComments').attr('commentId');
        var length = getWordLength(comment);

        if (length > 500) {
            alert('请不要超过500字哟^_^');
        } else if (comment.length <= 0) {
            alert('评论不能为空哟^_^');
        } else {
            $('#topicSubmitBtn').html('正在提交...');
            $('#topicSubmitBtn').attr('disabled', true);
            postTopicComment(comment, commentId);
        }
    });
    // 专题检测输入字数
    $('#topicComment').keyup(function () {
        var content = $('#topicComment').val();
        var length = getWordLength(content);
        var content = length + '/500';
        $('#tip').html(content);
        $('#topicSubmitBtn').attr('disabled', false);
        if (length > 500) {
            $('#topicComment').css('color', 'red');
            $('#tip').css('color', 'red');
            $('#topicSubmitBtn').attr('disabled', true);
        } else if (length == 0) {
            $('#topicSubmitBtn').attr('disabled', true);
        } else {
            $('#topicComment').css('color', '');
            $('#tip').css('color', '');
            $('#topicSubmitBtn').attr('disabled', false);
        }
    });
    // 专题下拉加载
    $('.topicComments').dropload({
        scrollArea: window,
        domDown: {
            domClass: 'dropload-down',
            domRefresh: '<div class="dropload-refresh"></div>',
            domLoad: '<div class="dropload-load"><span class="loading"></span></div>',
            domNoData: '<div class="dropload-noData"></div>'
            //            domRefresh : '<div class="dropload-refresh">加载更多</div>',
            //            domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中</div>',
            //            domNoData  : '<div class="dropload-noData">没有更多</div>'
        },
        loadDownFn: function (me) {
            var topicId = $('#topicComments').attr('topicid');
            var startnum = $('#topicComments').attr('comment-num');
            var url = '/m/mazi/topicComment/' + topicId + "/" + startnum;
            $.ajax({
                url: url,
                type: 'get',
                dataType: 'json',
                success: function (data, status) {
                    if (data.length === 0) {
                        //锁住下拉刷新
                        me.lock();
                        me.noData();
                    } else {
                        var html = insertToHtml(data);
                        $('#topicComments').append(html);
                        var commentNum = $('#topicComments').attr('comment-num');
                        $('#topicComments').attr('comment-num', data.length + parseInt(commentNum));
                    }
                    me.resetload();
                }
            });
        }
    });
});

/**
 * 提交评论界面
 * @param id
 */
function redirectSubmitPage(id) {
    var hasSubscription = $('.payColumn').length
    if (hasSubscription === 0){
        $('#topicComments').attr('commentId', id);
        $('#commentModal').modal('show');
    }else {
        $('#showTipsModal').modal('show');
    }

}

/**
 * 获取当前评论内容的字数长度
 * @param s
 * @returns {*}
 */
function getWordLength(s) {
    if (!s) return 0;
    var s1 = s.replace(/([^\x00-\xff])/g, ' | ');
    var s2 = s1.replace(/\s+/ig, ' ');
    var s2 = s2.replace(/ +/ig, ' ');
    var s2 = s2.replace(/^ */, '').replace(/ *$/, '');
    var curLength = s2.split(' ').length;
    return curLength;
}

/**
 * 专题提交评论的方法
 * @param sendData 发送数据
 * @param commentId
 */
function postTopicComment(sendData, commentId) {
    var topicId = $('#topicComments').attr('topicid');
    var requestUrl = encodeURI(window.location.href);
    var data = {
        content: sendData,
        topicId: topicId,
        requestUrl: requestUrl
    };
    if (commentId != 'null') {
        data.commentId = commentId;
    }

    var url = '/m/mazi/columnTopicComment';
    $.ajax({
        url: url,
        type: 'POST',
        data: JSON.stringify(data),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data, status) {
            if (data.code === 0) {
                var redirectUrl = window.location.href;
                var p = redirectUrl.indexOf('#writeCommentDiv');
                if (p != -1) {
                    redirectUrl = redirectUrl.substring(0, p) + redirectUrl.substring((p + '#writeCommentDiv'.length), redirectUrl.length);
                }

                window.location.href = redirectUrl + "#writeCommentDiv";
                location.reload();
            } else {
                alert('服务忙，稍后再试：）');
                $('#topicSubmitBtn').html('提交');
                $('#topicSubmitBtn').attr('disabled', false);
            }
        }
    });
}

/**
 * 点赞触发的时间
 * @param that
 */
function praiseComment(that) {
    var hasSubscription = $('.payColumn').length
    if (hasSubscription != 0) {
        $('#showTipsModal').modal('show');
        return
    }
    var isPraise = $(that).attr('ispraise');
    var commentId = $(that).attr('comment-id');
    var type;
    if (isPraise === 'false') {
        //点赞
        type = 'post';
    } else {
        //取消点赞
        type = 'delete';
    }
    var url = '/m/mazi/topicComment/Fav';
    $.ajax({
        url: url,
        type: type,
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify({
            commentId: commentId
        }),
        dataType: 'json',
        success: function (data, status) {
            if (data.code == 0 && type == 'post') {
                //点赞后
                $(that).attr('ispraise', true);
                $(that).toggleClass('comment-unpraise comment-praise');
                var num = parseInt($(that).next().html());
                $(that).next().html(num + 1);
            }
            if (data.code == 0 && type == 'delete') {
                //取消点赞后
                $(that).attr('ispraise', false);
                $(that).toggleClass('comment-unpraise comment-praise');
                var num = parseInt($(that).next().html());
                $(that).next().html(num - 1);
            }
        }
    });
}
/**
 * 将返回的加载评论数据转化成Html
 */

function insertToHtml(data) {
    var html = '';
    data.forEach(function (commentObject) {
        if (commentObject.status == 0) {
            html += parseObjectToHtml(commentObject);
        }
    });
    return html;
}

/**
 * 将Object类型的Comment转化成Html
 */
function parseObjectToHtml(commentObject) {
    if (!commentObject)
        return;
    var html = '';
    html += "<div class='col-xs-12 comment-item-div'>" +
        "<div class='comment-item'>" +
        "<div class='col-xs-2' style='padding:10px'>" +
        "<div class='comment-author-image' >" +
        "<img class='comment-author-thumb' src='" + commentObject.customerId.thumbImage + "'/>" +
        "</div>" +
        "</div>" +
        "<div class='col-xs-10' style='padding: 0px'>" +
        "<div class='comment-author-name'>" + commentObject.customerId.customerName + "</div>" +
        "<div class='comment-content-desc'>" + decodeURIComponent(commentObject.content) + "</div>" +
        "<div class='comment-footer'>" +
        "<div class='comment-time'>" + commentObject.dateString + "</div>" +
        parsePraiseObject(commentObject) +
        "<div class='comment-like-num'>" + commentObject.favNum + "</div>" +
        "<div onclick='redirectSubmitPage(\"" + commentObject._id + "\")' class='sub-comment'></div>" +
        "<div class='sub-comment-num'>" + commentObject.subComment.length + "</div>" +
        "</div>" +
        parseSubObjectToHtml(commentObject.subComment) +
        "</div>" +
        "</div>" +
        "</div>";
    return html;
}

/**
 * 将子评论数组转化成相应的HTML
 */
function parseSubObjectToHtml(subCommentArray) {
    var html = '';
    subCommentArray.forEach(function (subComment) {
        if (subComment.status === 0) {
            html +=
                "<div class='comment-comment'>" +
                "<span class='sub-comment-name'>" + subComment.customerId.customerName + "</span>" +
                "<span class='sub-comment-desc'>:" + decodeURIComponent(subComment.content) + "</span>" +
                "</div>"
        }
    });
    return html;
}

/**
 * 将对象转化成点赞显示的html
 */
function parsePraiseObject(commentObject) {
    var html = '';
    if (!commentObject.isPraise) {
        html += "<div class='comment-unpraise' ispraise='false' comment-id='" + commentObject._id + "' onclick='praiseComment(this)' ></div>";
    } else {
        html += "<div class='comment-praise' ispraise='true' comment-id='" + commentObject._id + "' onclick='praiseComment(this)' ></div>";
    }
    return html;
}

function removeURLParameter(url, parameter) {
    //prefer to use l.search if you have a location/link object
    var urlparts = url.split('?');
    if (urlparts.length >= 2) {

        var prefix = encodeURIComponent(parameter) + '=';
        var pars = urlparts[1].split(/[&;]/g);

        //reverse iteration as may be destructive
        for (var i = pars.length; i-- > 0;) {
            //idiom for string.startsWith
            if (pars[i].lastIndexOf(prefix, 0) !== -1) {
                pars.splice(i, 1);
            }
        }

        url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : "");
        return url;
    } else {
        return url;
    }
}
function topicFavBtnFun(topicId) {

    $.ajax({
        url: "/m/mazi/columnTopicFav",
        type: "POST",
        data: JSON.stringify({
            topicId: topicId
        }),
        contentType: "application/json; charset=utf-8",
        success: function (data, status) {
            if (status === 'success' && data.code === 0) {
                if (data.message === 'added') {
                    $('#favLink').css('color', '#c9a063');
                    $('#favLinkText').html('已赞');
                } else if (data.message === 'cancelled') {
                    $('#favLink').css('color', '#777777');
                    $('#favLinkText').html('点赞');
                }
            }
        }
    });
}--><script async src="https://www.googletagmanager.com/gtag/js?id=UA-96766334-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
var userId = '59237e7017e5f267938a788a';
if(userId && userId != '' && userId != 'do_not_exist'){
    gtag('set', {'user_id': userId});
}
gtag('config', 'UA-96766334-1');
var gEvent = ''
if (gEvent && gEvent != '') {
    gtag('event', gEvent);
}</script><script>var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?5667c6d502e51ebd8bd9e9be6790fb5d";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();</script><script>var readerCustomerId = '59237e7017e5f267938a788a';
var readingChatId = '';
var readingColumnId = '5d80aea449b2b1063b52990f';
var readingGeekbookId = '';
function getReferrer() {
    var referrer = "";
    try {
        referrer = window.top.document.referrer
    } catch (e) {
        if (window.parent) {
            try {
                referrer = window.parent.document.referrer
            } catch (e2) {
                referrer = ""
            }
        }
    }
    if (referrer === "") {
        referrer = document.referrer
    }
    return referrer
}

var tjSecond = 0;
var tjRandom = 0;
window.setInterval(function () {
    tjSecond++
}, 1000);
tjRandom = (new Date()).valueOf();
window.onbeforeunload = function () {
    if (
        readerCustomerId && readerCustomerId != ''
        &&
        (
            (readingChatId && readingChatId != '')||
            (readingColumnId && readingColumnId !='')||
            (readingGeekbookId && readingGeekbookId != '')
        )
    ) {
        var params = {};
        params.tjRd = tjRandom;
        params.url = location.href;
        params.time = tjSecond;
        params.timeIn = Date.parse(new Date()) - (tjSecond * 1000);
        params.timeOut = Date.parse(new Date());
        params.title = document.title;
        params.domain = document.domain;
        params.sh = window.screen.height;
        params.sw = window.screen.width;
        params.language = navigator.language;
        params.refer = getReferrer();
        params.readerCustomerId = readerCustomerId;
        params.readingChatId = readingChatId;
        params.readingColumnId = readingColumnId;
        params.readingGeekbookId = readingGeekbookId;
        $.ajax({
            url: "/m/track/reading/time",
            type: "POST",
            data: JSON.stringify(params),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data, status) {

            }
        });
    }

};</script></html>
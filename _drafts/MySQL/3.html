<!DOCTYPE html><html lang="en"><title>MySQL 事务的面试题总结</title><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, user-scalable=no"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover,minimum-scale=1.0, maximum-scale=1"><title>老王/张建的专栏</title><meta name="description" content="GitChat 是一款基于微信平台的知识分享产品。通过这款产品我们希望改变IT知识的学习方式。"><meta name="robots" content="index,follow"><meta name="keywords" content="GitChat,机器学习,大数据,程序员,用户体验,软件开发,知识付费,技术分享"><meta http-equiv="cache-control" content="max-age=0"><meta http-equiv="cache-control" content="no-cache"><meta http-equiv="expires" content="0"><meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv="pragma" content="no-cache"><meta name="baidu-site-verification" content="BRkuL6TTfM"><script src="/dist/site/gitchat/js1.js"></script><link href="/dist/css/bootstrap-toggle.min.css" rel="stylesheet"><link href="/dist/site/gitchat/bundle2.css" rel="stylesheet"><link rel="stylesheet" href="/css/gitchat/common/common.css"><script src="/dist/gitchat/js/common.js"></script><link rel="icon" type="image/png" href="https://images.gitbook.cn/FrfR1mB39xM-U6iSAmDCpxWVxvoa?imageslim" sizes="16x16"><link rel="icon" type="image/png" href="https://images.gitbook.cn/FrfR1mB39xM-U6iSAmDCpxWVxvoa?imageslim" sizes="32x32"></head><meta name="viewport" content="width=device-width, user-scalable=yes"><link href="/dist/gitchat/css/rpi.css" rel="stylesheet"><link href="/dist/gitchat/css/katex.min.css" rel="stylesheet"><script src="/dist/site/gitchat/js3.js"></script><script src="/dist/gitchat/js/columnRpi.js"></script><link href="/dist/site/gitchat/bundle1.css" rel="stylesheet"><link href="/css/gitchat/columnTopicDetail.css" rel="stylesheet"><link href="/dist/gitchat/css/columnListTemplate.css" rel="stylesheet"><link href="/dist/gitchat/css/readerGroupTemplate.css" rel="stylesheet"><body><input style="display:none;" id="refreshed" value="no"><script>var e = document.getElementById("refreshed");
if (e.value == "no") e.value = "yes";
else {
    e.value = "no";
    location.reload();
}</script><link rel="stylesheet" href="/css/gitchat/appBanner.css"><div class="app_banner"><div class="inner_banner"><img src="https://images.gitbook.cn/FiemqiGW5K9uxM-cSQWlrpiRP8Ua?imageslim" class="app_bg"><img id="downApp" src="https://images.gitbook.cn/Fg1FfEczUbS2nF4p2LT_erPD6d9I" class="app_btn"><span id="closeApp" class="app_close">×</span></div></div><script>var showStatus = true;
$('#downApp').on('click',function(){
    window.location.href = 'http://app.gitbook.cn/page/download?M_courcebanner';
    return false;
})
$('#closeApp').on('click',function(){
    $('.app_banner').fadeOut();
    showStatus = false;
    return false;
})
window.onscroll=function(){
    if(showStatus && $(document).scrollTop()>$('.app_banner').height()){
        $('.app_banner').fadeIn();
    }else{
        $('.app_banner').fadeOut();
    }
}</script><progress value="0" id="progressBar"><div class="progress-container"><span class="progress-bar"></span></div></progress><div id="topicContainer" class="topicContainer"><div class="no-mathjax topicTitle">MySQL 事务的面试题总结</div><article id="articleDiv" style="overflow: hidden;padding-bottom:15px;text-align: justify;"><div class="mazi-article-content dont-break-out"><h3 id="">事务是什么？</h3>
<p>事务是一系列的数据库操作，是数据库应用的基本单位。MySQL 事务主要用于处理操作量大，复杂度高的数据。</p>
<h3 id="-1">事务有哪些特性？</h3>
<p>在 MySQL 中只有 InnDB 引擎支持事务，它的四个特性如下：</p>
<ul>
<li>原子性（Atomic）：要么全部执行，要么全部不执行；</li>
<li>一致性（Consistency）：事务的执行使得数据库从一种正确状态转化为另一种正确状态；</li>
<li>隔离性（Isolation）：在事务正确提交之前，不允许把该事务对数据的任何改变提供给其他事务；</li>
<li>持久性（Durability）：事务提交后，其结果永久保存在数据库中。</li>
</ul>
<h3 id="mysql">MySQL 中有几种事务隔离级别？分别是什么？</h3>
<p>MySQL 中有四种事务隔离级别，它们分别是：</p>
<ul>
<li>read uncommited：未提交读，读到未提交数据；</li>
<li>read committed：读已提交，也叫不可重复读，两次读取到的数据不一致；</li>
<li>repetable read：可重复读；</li>
<li>serializable：串行化，读写数据都会锁住整张表，数据操作不会出错，但并发性能极低，开发中很少用到。</li>
</ul>
<p>MySQL 默认使用 REPEATABLE-READ 的事务隔离级别。</p>
<h3 id="-2">幻读和不可重复读的区别？</h3>
<ul>
<li>不可重复读的重点是修改：在同一事务中，同样的条件，第一次读的数据和第二次读的数据不一样。（因为中间有其他事务提交了修改）。</li>
<li>幻读的重点在于新增或者删除：在同一事务中，同样的条件,，第一次和第二次读出来的记录数不一样。（因为中间有其他事务提交了插入/删除）。</li>
</ul>
<h3 id="-3">并发事务一般有哪些问题？</h3>
<ul>
<li><p>更新丢失（Lost Update）：当两个或多个事务选择同一行，然后基于最初选定的值更新该行时，由于每个事务都不知道其他事务的存在，就会发生丢失更新问题，最后的更新覆盖了由其他事务所做的更新。例如，两个编辑人员制作了同一文档的电子副本，每个编辑人员独立地更改其副本，然后保存更改后的副本，这样就覆盖了原始文档。 最后保存其更改副本的编辑人员覆盖另一个编辑人员所做的更改，如果在前一个编辑人员完成并提交事务之前，另一个编辑人员不能访问同一文件，则可避免此问题。</p></li>
<li><p>脏读（Dirty Reads）：一个事务正在对一条记录做修改，在这个事务完成并提交前， 这条记录的数据就处于不一致状态； 这时， 另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些脏数据，并据此做进一步的处理，就会产生未提交的数据依赖关系，这种现象被形象地叫做脏读。</p></li>
<li><p>不可重复读（Non-Repeatable Reads）：一个事务在读取某些数据后的某个时间，再次读取以前读过的数据，却发现其读出的数据已经发生了改变、或某些记录已经被删除了！这种现象就叫做“不可重复读” 。</p></li>
<li><p>幻读（Phantom Reads）： 一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读” 。</p></li>
</ul>
<h3 id="-4">并发事务有什么什么问题？应该如何解决？</h3>
<p>并发事务可能造成：脏读、不可重复读和幻读等问题 ，这些问题其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决，解决方案如下：</p>
<ul>
<li>加锁：在读取数据前，对其加锁，阻止其他事务对数据进行修改。</li>
<li>提供数据多版本并发控制（MultiVersion Concurrency Control，简称 MVCC 或 MCC），也称为多版本数据库：不用加任何锁， 通过一定机制生成一个数据请求时间点的一致性数据快照（Snapshot)， 并用这个快照来提供一定级别 （语句级或事务级） 的一致性读取，从用户的角度来看，好象是数据库可以提供同一数据的多个版本。</li>
</ul>
<h3 id="mvcc">什么是 MVCC？</h3>
<p>MVCC 全称是多版本并发控制系统，InnoDB 和 Falcon 存储引擎通过多版本并发控制（MVCC，Multiversion Concurrency Control）机制解决幻读问题。</p>
<h3 id="mvcc-1">MVCC 是怎么工作的？</h3>
<p>InnoDB 的 MVCC 是通过在每行记录后面保存两个隐藏的列来实现，这两个列一个保存了行的创建时间，一个保存行的过期时间（删除时间）。当然存储的并不是真实的时间而是系统版本号（system version number）。每开始一个新的事务，系统版本号都会自动新增，事务开始时刻的系统版本号会作为事务的版本号，用来查询到每行记录的版本号进行比较。</p>
<h3 id="repeatablereadmvcc">REPEATABLE READ（可重读）隔离级别下 MVCC 如何工作？</h3>
<ul>
<li>SELECT：InnoDB 会根据以下条件检查每一行记录：第一，InnoDB 只查找版本早于当前事务版本的数据行，这样可以确保事务读取的行要么是在开始事务之前已经存在要么是事务自身插入或者修改过的。第二，行的删除版本号要么未定义，要么大于当前事务版本号，这样可以确保事务读取到的行在事务开始之前未被删除。</li>
<li>INSERT：InnoDB 为新插入的每一行保存当前系统版本号作为行版本号。</li>
<li>DELETE：InnoDB 为删除的每一行保存当前系统版本号作为行删除标识。</li>
<li>UPDATE：InnoDB 为插入的一行新纪录保存当前系统版本号作为行版本号，同时保存当前系统版本号到原来的行作为删除标识保存这两个版本号，使大多数操作都不用加锁。它不足之处是每行记录都需要额外的存储空间，需要做更多的行检查工作和一些额外的维护工作。</li>
</ul>
<h3 id="mysql-1">MySQL 事务实现原理是什么？</h3>
<p>事务的实现是基于数据库的存储引擎，不同的存储引擎对事务的支持程度不一样。MySQL 中支持事务的存储引擎有InnoDB 和 NDB。
InnoDB 是高版本 MySQL 的默认的存储引擎，因此就以 InnoDB 的事务实现为例，InnoDB 是通过多版本并发控制（MVCC，Multiversion Concurrency Control ）解决不可重复读问题，加上间隙锁（也就是并发控制）解决幻读问题。因此 InnoDB 的 RR 隔离级别其实实现了串行化级别的效果，而且保留了比较好的并发性能。事务的隔离性是通过锁实现，而事务的原子性、一致性和持久性则是通过事务日志实现。 </p>
<h3 id="mysql-2">如何设置 MySQL 的事务隔离级别？</h3>
<p>MySQL 事务隔离级别 MySQL.cnf 文件里设置的（默认目录 /etc/my.cnf），在文件的文末添加配置：</p>
<blockquote>
  <p>transaction-isolation = REPEATABLE-READ</p>
</blockquote>
<p>可用的配置值：READ-UNCOMMITTED、READ-COMMITTED、REPEATABLE-READ、SERIALIZABLE。</p>
<h3 id="innodb">InnoDB 默认的事务隔离级别是什么？如何修改？</h3>
<p>InnoDB 默认的事务隔离是 repetable read（可重复读）；可以通过 <code>set 作用域 transaction isolation level 事务隔离级别</code> 来修改事务的隔离级别，比如：</p>
<blockquote>
  <p>MySQL&gt; set global transaction isolation level read committed;  // 设置全局事务隔离级别为 read committed<br />
  MySQL&gt; set session transaction isolation level read committed; // 设置当前会话事务隔离级别为 read committed </p>
</blockquote>
<h3 id="innodb-1">InnoDB 如何开启手动提交事务？</h3>
<p>InnoDB 默认是自动提交事务的，每一次 SQL 操作（非 select 操作）都会自动提交一个事务，如果要手动开启事务需要设置 <code>set autocommit=0</code> 禁止自动提交事务，相当于开启手动提交事务。</p>
<h3 id="innodbautocommit0">在 InnoDB 中设置了 autocommit=0，添加一条信息之后没有手动执行提交操作，请问这条信息可以被查到吗？</h3>
<p>autocommit=0 表示禁止自动事务提交，在添加操作之后没有进行手动提交，默认情况下其他连接客户端是查询不到此条新增数据的。</p>
<h3 id="-5">如何手动操作事务？</h3>
<p>使用 begin 开启事务；rollback 回滚事务；commit 提交事务。具体使用示例如下：</p>
<pre><code class="sql language-sql">begin;
insert person(uname,age) values('laowang',18);
rollback;
commit;
</code></pre>
<hr />
<h2 id="-6">限时福利</h2>
<p><font color=#008000><strong>加入作者群，与大佬面对面交流，同时还能获得最新面试经验。
赶紧添加小助手「xiangcode」，发送暗号「6000」即可</strong></font></p></div></article><div id="writeCommentDiv" style="margin-top: 10px;display:none;"><div class="col-xs-12 comment-btn-div"><button onclick="redirectSubmitPage(&quot;null&quot;,&quot;true&quot;)" class="mazi-comment-btn">写评论</button></div></div><div style="display:none;" class="topicComments"><div id="topicComments" topicid="5d80b26c49b2b1063b529959" comment-num="0" columnId="5d80aea449b2b1063b52990f"></div></div><div id="hasSubscription"></div><div id="commentModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" data-dismiss="modal" aria-label="Close" class="close"><span aria-hidden="true">&times;</span></button><h4 style="text-align:center;margin:0;">文章评论</h4></div><div style="padding-bottom:10;" class="modal-body"><div class="row"><div style="text-align:right" class="col-xs-12"><textarea id="topicComment" rows="7" style="width:100%;border:1px solid #cccccc;-webkit-appearance:none;"></textarea><span id="tip">0/200</span></div></div></div><div class="modal-footer"><button id="topicSubmitBtn" disabled="disabled" style="width:100%" class="btn btn-primary">提交</button></div></div></div></div><script>function showTip() {
    $('#pdfTips').modal('show')
}
function openPdf(){
    window.location.href = '';
}</script><div class="split_line"></div><div class="topic_item"><div class="topic-cell"><div class="wrapper"><div class="userInfo"><div class="avatorWrapper"><img src="https://images.gitbook.cn/663e5710-b748-11e8-b809-d915783fbfe8?imageView2/2/h/50" width="20" height="20" class="header_img"></div><div class="feedInfo"><div class="userName">torres</div></div><div class="feedTime">2019-09-28 13:50</div></div><div class="feedContent"><div class="talkContent"><div class="text talk_detail"><span style="display: block;overflow: hidden" class="topic_text">赞，深度好文</span><div class="clearfix"></div></div></div></div></div></div><div class="topic-cell"><div class="wrapper"><div class="userInfo"><div class="avatorWrapper"><img src="https://images.gitbook.cn/98b860c0-952c-11e8-b8b3-690dce6077c1?imageView2/2/h/50" width="20" height="20" class="header_img"><img src="http://images.gitbook.cn/cvip.png" height="30" width="30" class="vIcon"></div><div class="feedInfo"><div class="userName">老王</div></div><div class="feedTime">2019-09-26 23:19</div></div><div class="feedContent"><div class="qaContent"><div class="answerText">group by 在满足条件的情况下会走索引，比如，select tid from t where tid&amp;gt;10 group by tid，当 where 和 group by 都是同样的字段时，就会走索引。</div><div class="text question_view"><span class="questioner">______Wm提问：</span><span>请问group by走索引吗</span></div></div><div class="comment"><ul><li class="contentWrapper"><div><span class="userName">______Wm</span><div class="commentContent">谢谢</div></div></li></ul></div></div></div></div></div><a style="" href="/chatGroup.html#/groups/5b55849bc28306099b47ae7d" data-toggle="modal" data-target="" class="reader_btn">查看更多</a><div class="detail_bottom"><div class="detail_bottom_menu"><a href="/m/mazi/comp/column?columnId=5d80aea449b2b1063b52990f&amp;tag=2#catalog" class="detail_catalog_2"><img src="https://images.gitbook.cn/FoNYstI_LM90qvSH1CcqIPRPXi93"></a><a href="/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b1f649b2b1063b529956" class="detail_bottom_left"><img src="https://images.gitbook.cn/FtV6I5EsuprXLmIzsQ89j-7QfsNa" class="arrow_image"></a><a href="/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b32a49b2b1063b52995b" class="detail_bottom_right"><img src="https://images.gitbook.cn/FuV9gG3eLhk3WBTFebaE7Y3fo7ns" class="arrow_image"></a><a href="/chatGroup.html#/groups/5b55849bc28306099b47ae7d" style="" class="detail_readers"><img src="https://images.gitbook.cn/FjM1UjGTLGkqf-VqNqnGWuQUZo-H"></a></div></div></div><div id="inviteCardModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" style="margin:0 auto;padding:10px 10px 0;" class="modal-dialog"><div style="background:#fcfcfc" class="modal-content"><div style="text-align:center;padding:10px;background:#fff;border:none;" class="modal-header"><h4 id="inviteCardModalLabel" style="font-size:16px;font-weight:700;color: #3f3f3f;text-align: center;" class="modal-title">长按图片分享或保存</h4></div><div style="padding:0;line-height:30px;overflow:auto;-webkit-overflow-scrolling: touch;" class="modal-body"><div id="inviteCardLoader" style="text-align:center;height:200px;"><div style="margin-top:140px;"><img style="width:50px;" src="https://images.gitbook.cn/loading_spinner.gif"></div><div style="color:#ccc;">正在生成图片...</div></div><div id="inviteCardbody" style="text-align:center;display:none;height:320px;min-height:320px;"><img id="inviteCardImg" style="width:100%"></div></div><div style="text-align:center;padding:10px;background:rgba(255,255,255,0.9);" class="modal-footer"><div style="font-size:12px;color:#333;">用专属海报每邀请一位好友购买，即可获得原价的 1/4 作为奖励。上不封顶，立即提现。您可以在「我-我的邀请奖励」中查看邀请详情并进行提现。</div><a style="font-size:14px;color:#FF700A;background:#FDF2E0;border-radius:20px;margin:10px auto 0;display:inline-block;text-align:center;padding:6px 15px;" href="/m/mazi/statistic/invites/column/5d80aea449b2b1063b52990f">查看分享达人排行        </a></div></div><div style="background:rgba(0,0,0,0);text-align:center;" class="modal-colse"><img data-dismiss="modal" aria-label="Close" style="width:50px;" src="https://images.gitbook.cn/FvFDp80XHoLkvq8pNhBm3CWUWW4r"></div></div></div><div id="showInviteCardTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 style="text-align:center;" class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">成功购买本专栏，即可获得专属返利海报！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="showTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div style="text-align:center;" class="modal-header"><h4 class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">快去预订吧！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="showVIPBuyModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-header"><h4 style="text-align:center;" class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div id="showVIPBuyText" style="text-align:center;"></div></div><div style="margin-top: 10px;text-align:center;" class="modal-footer"><a href="/m/mazi/comp/column?columnId=5d80aea449b2b1063b52990f" class="btn btn-primary">知道了</a></div></div></div></div><div id="showNotFinishedTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div style="text-align:center;" class="modal-header"><h4 class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">作者正在写作中，请耐心等待！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="showNeedBuyTipsModal" style="margin-top: 100px;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" data-dismiss="modal" class="modal-dialog"><div class="modal-content"><div style="text-align:center;" class="modal-header"><h4 class="modal-title">提 示</h4></div><div style="padding:10px 20px 5px 20px;line-height:30px;" class="modal-body"><div style="text-align:center;">购买本专栏，即可继续阅读文章！</div></div><div style="text-align:center;" class="modal-footer"><div data-dismiss="modal" class="btn btn-primary">知道了</div></div></div></div></div><div id="appClick" style="display:none" data-toggle="modal" data-target="#appModal"></div><div id="appModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" class="modal fade"><div role="document" class="modal-dialog"><div class="modal-content"><div class="modal-body"><img src="https://images.gitbook.cn/FmmfLbTAH8_vkKHDDvzCOXFGxTa_"><div class="app_btns"><a href="http://app.gitbook.cn/page/download" class="download_btn"></a><div data-dismiss="modal" class="close_btn">果断拒绝</div></div></div></div></div></div></body><script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script><script>$.ajax ({
    url: "/weixin/signature",
    type: "POST",
    data: JSON.stringify({url:window.location.href}),
    dataType: "json",
    contentType: "application/json; charset=utf-8",
    success: function(data,status){
        if(data.code == 0){
            wx.config({
            debug: false,
            appId: 'wx7ba47eadabd9ddde',
            timestamp: data.timestamp,
            nonceStr: data.nonce,
            signature: data.sha1,
            jsApiList: ['onMenuShareTimeline','onMenuShareAppMessage','onMenuShareQQ','onMenuShareWeibo','onMenuShareQZone','chooseWXPay']
            });
            wx.ready(function(){
                //alert('config check successfully.');
                wx.onMenuShareTimeline({
                title: 'MySQL 事务的面试题总结 | 老王/张建', // 分享标题
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b26c49b2b1063b529959?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType:'', // activity, article, author, others
                            shareItemId:'',
                            shareToken:'',
                            shareChanel:'weixinTimeline',
                            shareItemUrl:window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareAppMessage({
                title: 'MySQL 事务的面试题总结 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b26c49b2b1063b529959?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                type: 'link', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function () {
                    // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType: '', // activity, article, author, others
                            shareItemId: '',
                            shareToken: '',
                            shareChanel: 'weixinMessage',
                            shareItemUrl: window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareQQ({
                title: 'MySQL 事务的面试题总结 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b26c49b2b1063b529959?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType: '', // activity, article, author, others
                            shareItemId: '',
                            shareToken: '',
                            shareChanel: 'qq',
                            shareItemUrl: window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareWeibo({
                title: 'MySQL 事务的面试题总结 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b26c49b2b1063b529959?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
                wx.onMenuShareQZone({
                title: 'MySQL 事务的面试题总结 | 老王/张建', // 分享标题
                desc: '获得高薪的关键：就是高效的准备面试', // 分享描述
                link: 'https://gitbook.cn/m/mazi/columns/5d80aea449b2b1063b52990f/topics/5d80b26c49b2b1063b529959?utm_source=columnweixinshare&utm_campaign=%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%20MySQL%20%E9%9D%A2%E8%AF%95%E9%87%91%E5%85%B8', // 分享链接
                imgUrl: 'https://images.gitbook.cn/Ftb77Lsip5yvRhhPYgDO1aBxNVjl?imageView2/0/h/500/', // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                    $.ajax({
                        url: "/m/mazi/share/event",
                        type: "POST",
                        data: JSON.stringify({
                            shareItemType: '', // activity, article, author, others
                            shareItemId: '',
                            shareToken: '',
                            shareChanel: 'QZone',
                            shareItemUrl: window.location.href
                        }),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (data, status) {

                        }
                    });
                },
                cancel: function () {
                // 用户取消分享后执行的回调函数
                }
                });
            });
            wx.error(function (res) {
            });
        }
    }
});</script><script type="text/x-mathjax-config">MathJax.Hub.Config({messageStyle: "none",CommonHTML: {linebreaks: {automatic: true}},tex2jax: {inlineMath: [['$$','$$'],['$','$'], ['\\(','\\)']], processClass: "mathjax",ignoreClass: "no-mathjax"}});</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML"></script><script>hljs.initHighlightingOnLoad();
$(function(){
    var columnId = '5d80aea449b2b1063b52990f';
})
wx.ready(function() {
    var audio = document.getElementById("audio");
    if (audio) {
        audioConfig()
    }

});
function backToDetail(id){
    window.location.href=`/m/mazi/comp/column?columnId=${id}`;
}
$("#control").click(function() {
    var audio = document.getElementById("audio");
    if ($("#control").hasClass("play")) {
        $("#control").addClass("pause").removeClass("play");
        audio.play();//开始播放
    } else {
        $("#control").addClass("play").removeClass("pause");
        audio.pause();
    }
})
function getColumnInviteCard(columnId){
    $('#inviteCardModal').modal('show');
    var requestUrl = encodeURI(window.location.href);
    $.ajax({
        url: "/m/mazi/columnInviteCard/" + columnId,
        type: "POST",
        data: JSON.stringify({requestUrl: requestUrl}),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data, status) {
            if (status == 'success' && data.code == 0) {
                $('#inviteCardLoader').hide();
                $('#inviteCardbody').show();
                $('#inviteCardImg').attr('src', data.imgUrl);
            } else if (data.code == -1 && data.redirectUrl && data.redirectUrl != '') {
                $('#inviteCardModal').modal('hide');
                window.location.href = data.redirectUrl + '?err=' + data.message;
            } else {
                $('#inviteCardModal').modal('hide');
                alert(JSON.stringify(data.message));
            }
        }
    });
}

function getColumnInviteCardTip(columnId){
    $('#showInviteCardTipsModal').modal('show');
}
function audioConfig() {
    var audio = document.getElementById("audio");
    $("#control").addClass("play")
    audio.loop = true; //歌曲循环
    console.log('audio.duration', audio.duration)
    if (audio.duration) {
        var minute =  parseInt(audio.duration/60) 
        var second = parseInt(Math.round(audio.duration%60))
        if (second < 10) second = `0${second}` 
        if (minute < 10) minute = `0${minute}` 
        $("#allTime").html(`${minute}′${second}′′`);
    }
    audio.addEventListener("loadeddata", //歌曲一经完整的加载完毕( 也可以写成上面提到的那些事件类型)
    function() {
        var minute =  parseInt(audio.duration/60) 
        var second = parseInt(Math.round(audio.duration%60))
        if (second < 10) second = `0${second}` 
        if (minute < 10) minute = `0${minute}` 
        $("#allTime").html(`${minute}′${second}′′`);
        // 按钮
    }, false);

    audio.addEventListener("pause",
        function() { //监听暂停
            $("#control").addClass("play").removeClass("pause");
            if (audio.currentTime == audio.duration) {
                audio.stop();
                audio.currentTime = 0;
            }
        }, false);
    audio.addEventListener("play",
        function() { //监听暂停
            $("#control").addClass("pause").removeClass("play");
        }, false);
    audio.addEventListener("ended", function() {
        alert(0)
    }, false)
}</script><!--script.$(document).ready(function () {
    // 专题提交按钮
    $('#topicSubmitBtn').click(function () {
        var comment = $('#topicComment').val();
        var commentId = $('#topicComments').attr('commentId');
        var length = getWordLength(comment);

        if (length > 500) {
            alert('请不要超过500字哟^_^');
        } else if (comment.length <= 0) {
            alert('评论不能为空哟^_^');
        } else {
            $('#topicSubmitBtn').html('正在提交...');
            $('#topicSubmitBtn').attr('disabled', true);
            postTopicComment(comment, commentId);
        }
    });
    // 专题检测输入字数
    $('#topicComment').keyup(function () {
        var content = $('#topicComment').val();
        var length = getWordLength(content);
        var content = length + '/500';
        $('#tip').html(content);
        $('#topicSubmitBtn').attr('disabled', false);
        if (length > 500) {
            $('#topicComment').css('color', 'red');
            $('#tip').css('color', 'red');
            $('#topicSubmitBtn').attr('disabled', true);
        } else if (length == 0) {
            $('#topicSubmitBtn').attr('disabled', true);
        } else {
            $('#topicComment').css('color', '');
            $('#tip').css('color', '');
            $('#topicSubmitBtn').attr('disabled', false);
        }
    });
    // 专题下拉加载
    $('.topicComments').dropload({
        scrollArea: window,
        domDown: {
            domClass: 'dropload-down',
            domRefresh: '<div class="dropload-refresh"></div>',
            domLoad: '<div class="dropload-load"><span class="loading"></span></div>',
            domNoData: '<div class="dropload-noData"></div>'
            //            domRefresh : '<div class="dropload-refresh">加载更多</div>',
            //            domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中</div>',
            //            domNoData  : '<div class="dropload-noData">没有更多</div>'
        },
        loadDownFn: function (me) {
            var topicId = $('#topicComments').attr('topicid');
            var startnum = $('#topicComments').attr('comment-num');
            var url = '/m/mazi/topicComment/' + topicId + "/" + startnum;
            $.ajax({
                url: url,
                type: 'get',
                dataType: 'json',
                success: function (data, status) {
                    if (data.length === 0) {
                        //锁住下拉刷新
                        me.lock();
                        me.noData();
                    } else {
                        var html = insertToHtml(data);
                        $('#topicComments').append(html);
                        var commentNum = $('#topicComments').attr('comment-num');
                        $('#topicComments').attr('comment-num', data.length + parseInt(commentNum));
                    }
                    me.resetload();
                }
            });
        }
    });
});

/**
 * 提交评论界面
 * @param id
 */
function redirectSubmitPage(id) {
    var hasSubscription = $('.payColumn').length
    if (hasSubscription === 0){
        $('#topicComments').attr('commentId', id);
        $('#commentModal').modal('show');
    }else {
        $('#showTipsModal').modal('show');
    }

}

/**
 * 获取当前评论内容的字数长度
 * @param s
 * @returns {*}
 */
function getWordLength(s) {
    if (!s) return 0;
    var s1 = s.replace(/([^\x00-\xff])/g, ' | ');
    var s2 = s1.replace(/\s+/ig, ' ');
    var s2 = s2.replace(/ +/ig, ' ');
    var s2 = s2.replace(/^ */, '').replace(/ *$/, '');
    var curLength = s2.split(' ').length;
    return curLength;
}

/**
 * 专题提交评论的方法
 * @param sendData 发送数据
 * @param commentId
 */
function postTopicComment(sendData, commentId) {
    var topicId = $('#topicComments').attr('topicid');
    var requestUrl = encodeURI(window.location.href);
    var data = {
        content: sendData,
        topicId: topicId,
        requestUrl: requestUrl
    };
    if (commentId != 'null') {
        data.commentId = commentId;
    }

    var url = '/m/mazi/columnTopicComment';
    $.ajax({
        url: url,
        type: 'POST',
        data: JSON.stringify(data),
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (data, status) {
            if (data.code === 0) {
                var redirectUrl = window.location.href;
                var p = redirectUrl.indexOf('#writeCommentDiv');
                if (p != -1) {
                    redirectUrl = redirectUrl.substring(0, p) + redirectUrl.substring((p + '#writeCommentDiv'.length), redirectUrl.length);
                }

                window.location.href = redirectUrl + "#writeCommentDiv";
                location.reload();
            } else {
                alert('服务忙，稍后再试：）');
                $('#topicSubmitBtn').html('提交');
                $('#topicSubmitBtn').attr('disabled', false);
            }
        }
    });
}

/**
 * 点赞触发的时间
 * @param that
 */
function praiseComment(that) {
    var hasSubscription = $('.payColumn').length
    if (hasSubscription != 0) {
        $('#showTipsModal').modal('show');
        return
    }
    var isPraise = $(that).attr('ispraise');
    var commentId = $(that).attr('comment-id');
    var type;
    if (isPraise === 'false') {
        //点赞
        type = 'post';
    } else {
        //取消点赞
        type = 'delete';
    }
    var url = '/m/mazi/topicComment/Fav';
    $.ajax({
        url: url,
        type: type,
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify({
            commentId: commentId
        }),
        dataType: 'json',
        success: function (data, status) {
            if (data.code == 0 && type == 'post') {
                //点赞后
                $(that).attr('ispraise', true);
                $(that).toggleClass('comment-unpraise comment-praise');
                var num = parseInt($(that).next().html());
                $(that).next().html(num + 1);
            }
            if (data.code == 0 && type == 'delete') {
                //取消点赞后
                $(that).attr('ispraise', false);
                $(that).toggleClass('comment-unpraise comment-praise');
                var num = parseInt($(that).next().html());
                $(that).next().html(num - 1);
            }
        }
    });
}
/**
 * 将返回的加载评论数据转化成Html
 */

function insertToHtml(data) {
    var html = '';
    data.forEach(function (commentObject) {
        if (commentObject.status == 0) {
            html += parseObjectToHtml(commentObject);
        }
    });
    return html;
}

/**
 * 将Object类型的Comment转化成Html
 */
function parseObjectToHtml(commentObject) {
    if (!commentObject)
        return;
    var html = '';
    html += "<div class='col-xs-12 comment-item-div'>" +
        "<div class='comment-item'>" +
        "<div class='col-xs-2' style='padding:10px'>" +
        "<div class='comment-author-image' >" +
        "<img class='comment-author-thumb' src='" + commentObject.customerId.thumbImage + "'/>" +
        "</div>" +
        "</div>" +
        "<div class='col-xs-10' style='padding: 0px'>" +
        "<div class='comment-author-name'>" + commentObject.customerId.customerName + "</div>" +
        "<div class='comment-content-desc'>" + decodeURIComponent(commentObject.content) + "</div>" +
        "<div class='comment-footer'>" +
        "<div class='comment-time'>" + commentObject.dateString + "</div>" +
        parsePraiseObject(commentObject) +
        "<div class='comment-like-num'>" + commentObject.favNum + "</div>" +
        "<div onclick='redirectSubmitPage(\"" + commentObject._id + "\")' class='sub-comment'></div>" +
        "<div class='sub-comment-num'>" + commentObject.subComment.length + "</div>" +
        "</div>" +
        parseSubObjectToHtml(commentObject.subComment) +
        "</div>" +
        "</div>" +
        "</div>";
    return html;
}

/**
 * 将子评论数组转化成相应的HTML
 */
function parseSubObjectToHtml(subCommentArray) {
    var html = '';
    subCommentArray.forEach(function (subComment) {
        if (subComment.status === 0) {
            html +=
                "<div class='comment-comment'>" +
                "<span class='sub-comment-name'>" + subComment.customerId.customerName + "</span>" +
                "<span class='sub-comment-desc'>:" + decodeURIComponent(subComment.content) + "</span>" +
                "</div>"
        }
    });
    return html;
}

/**
 * 将对象转化成点赞显示的html
 */
function parsePraiseObject(commentObject) {
    var html = '';
    if (!commentObject.isPraise) {
        html += "<div class='comment-unpraise' ispraise='false' comment-id='" + commentObject._id + "' onclick='praiseComment(this)' ></div>";
    } else {
        html += "<div class='comment-praise' ispraise='true' comment-id='" + commentObject._id + "' onclick='praiseComment(this)' ></div>";
    }
    return html;
}

function removeURLParameter(url, parameter) {
    //prefer to use l.search if you have a location/link object
    var urlparts = url.split('?');
    if (urlparts.length >= 2) {

        var prefix = encodeURIComponent(parameter) + '=';
        var pars = urlparts[1].split(/[&;]/g);

        //reverse iteration as may be destructive
        for (var i = pars.length; i-- > 0;) {
            //idiom for string.startsWith
            if (pars[i].lastIndexOf(prefix, 0) !== -1) {
                pars.splice(i, 1);
            }
        }

        url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : "");
        return url;
    } else {
        return url;
    }
}
function topicFavBtnFun(topicId) {

    $.ajax({
        url: "/m/mazi/columnTopicFav",
        type: "POST",
        data: JSON.stringify({
            topicId: topicId
        }),
        contentType: "application/json; charset=utf-8",
        success: function (data, status) {
            if (status === 'success' && data.code === 0) {
                if (data.message === 'added') {
                    $('#favLink').css('color', '#c9a063');
                    $('#favLinkText').html('已赞');
                } else if (data.message === 'cancelled') {
                    $('#favLink').css('color', '#777777');
                    $('#favLinkText').html('点赞');
                }
            }
        }
    });
}--><script async src="https://www.googletagmanager.com/gtag/js?id=UA-96766334-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
var userId = '59237e7017e5f267938a788a';
if(userId && userId != '' && userId != 'do_not_exist'){
    gtag('set', {'user_id': userId});
}
gtag('config', 'UA-96766334-1');
var gEvent = ''
if (gEvent && gEvent != '') {
    gtag('event', gEvent);
}</script><script>var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?5667c6d502e51ebd8bd9e9be6790fb5d";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();</script><script>var readerCustomerId = '59237e7017e5f267938a788a';
var readingChatId = '';
var readingColumnId = '5d80aea449b2b1063b52990f';
var readingGeekbookId = '';
function getReferrer() {
    var referrer = "";
    try {
        referrer = window.top.document.referrer
    } catch (e) {
        if (window.parent) {
            try {
                referrer = window.parent.document.referrer
            } catch (e2) {
                referrer = ""
            }
        }
    }
    if (referrer === "") {
        referrer = document.referrer
    }
    return referrer
}

var tjSecond = 0;
var tjRandom = 0;
window.setInterval(function () {
    tjSecond++
}, 1000);
tjRandom = (new Date()).valueOf();
window.onbeforeunload = function () {
    if (
        readerCustomerId && readerCustomerId != ''
        &&
        (
            (readingChatId && readingChatId != '')||
            (readingColumnId && readingColumnId !='')||
            (readingGeekbookId && readingGeekbookId != '')
        )
    ) {
        var params = {};
        params.tjRd = tjRandom;
        params.url = location.href;
        params.time = tjSecond;
        params.timeIn = Date.parse(new Date()) - (tjSecond * 1000);
        params.timeOut = Date.parse(new Date());
        params.title = document.title;
        params.domain = document.domain;
        params.sh = window.screen.height;
        params.sw = window.screen.width;
        params.language = navigator.language;
        params.refer = getReferrer();
        params.readerCustomerId = readerCustomerId;
        params.readingChatId = readingChatId;
        params.readingColumnId = readingColumnId;
        params.readingGeekbookId = readingGeekbookId;
        $.ajax({
            url: "/m/track/reading/time",
            type: "POST",
            data: JSON.stringify(params),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (data, status) {

            }
        });
    }

};</script></html>
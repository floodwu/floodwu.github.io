---
layout: post
title:  "微信公众号支付功能开发流程"
date: 2017-04-05 00:00:01
categories: 解决实际问题
tags: 微信公众号开发
excerpt: ""
---

通过表单拿到下单参数
调用下单接口，获取微信下单支付配置
调用jsSDK配置接口，获取jsSDK配置
配置jsSDK，成功后用下单支付的配置创建订单


1. 登录ecs，配置nginx vhost
* 拉代码
* 新增vhost
mobile.conf
```
server {
  listen  80;
  server_name mobile.troublehub.com;
...
```
* 绑定host：
```
0.0.0.0 mobile.troublehub.com
```

* reload nginx:
```
nginx -s reload
```

2. 绑定域名
A记录：
```
mobile 106.14.255.169
```

3. 登录微信公众号后台，设置服务器配置
url: http://mobile.troublehub.com/wechat/callback
token: ***
EncodingAESKey : 随机

4. 后台代码配置
WECHAT_APPID = **
WECHAT_SECRET = **
WECHAT_TOKEN = **
WECHAT_AES_KEY = **

5. 开发获取jsSDK配置的接口
使用的easyWechat开源库，在phalcon DI中注册实例为wechat（读取配置，返回实例对象，详细代码略）。
```php
public function jsSdkAction()
{
  $this->wechat->js->setUrl(urldecode($this->input['url']));
  $this->log->error(json_encode($this->input));

  // getBrandWCPayRequest为需要调用的wx js接口
  return $this->responseData($this->wechat->js->config(
    $apiArray = ['getBrandWCPayRequest',]
  ));
}
```
测试：
http://mobile.troublehub.com/wechat/jsSdk
返回：
```
{
    "success": true,
    "data": "{\"debug\":false,\"beta\":false,\"appId\":\"wx2dbfcf8d32f00ea0\",\"nonceStr\":\"H1Tz1QW9xi\",\"timestamp\":1491669904,\"url\":\"http:\\/\\/mobile.troublehub.com\\/wechat\\/jsSdk\",\"signature\":\"250eb980e3326bc502384193a224af969965cfbf\",\"jsApiList\":[\"getBrandWCPayRequest\"]}",
    "code": 1,
    "message": "成功"
}
```
猜测前端拿到数据后，通过wxJsBridge唤起微信支付时，微信会通过nonceStr加其他数据生成签名后与signature进行比较来判断真实性。


6. 登录微信公众号管理后台设置各种域名
* 设置js接口安全域名 mobile.troublehub.com
* 设置业务域名 mobile.troublehub.com  // 这样微信在访问该域名时就不会弹出警告信息，影响排版
* 授权回调页面域名 mobile.troublehub.com  // 用户在网页授权页同意授权给公众号后，微信会将授权数据传给一个回调页面，回调页面需在此域名下，以确保安全可靠。
* 公众号支付-支付授权目录 http://mobile.troublehub.com/

7. 开发获取支付配置的接口



































































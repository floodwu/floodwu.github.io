---
layout: post
title:  "XML报文数字签名开发流程总结"
date: 2017-04-26 00:00:01
categories: 开发总结
tags: XML PHP
excerpt: "XML签名开发总结，涉及XML数字签名规范、C14N规范、封内加签、X.509 V3标准、SHA-1+RSA等"
---

* content
{:toc}


# 概念&文档
* 《XML数字签名规范》（W3C XML signature recommendation on 12 February 2002） 
https://www.w3.org/TR/2002/REC-xmldsig-core-20020212/

* 规范化XML
预处理XML文档以实现纯文本比较和数字签名。

* C14N规范
Canonical XML，一种生成XML文档物理表示的标准方法。

* 封内加签
元素成为被签名数据的子元素。

* X.509标准
数字证书标准，一种非常通用的证书格式。一份X.509证书是一些标准字段的集合（**含证书持有人的公钥信息及所使用的加密算法**）。
常用文件扩展名：`.cer`、 `.crt`- 通常被用于二进制的DER文件格式(同于`.der`)，不过也被用于Base64编码的文件 (例如`.pem`).

* SHA
安全哈希算法（Secure Hash Algorithm），主要适用于数字签名标准（Digital Signature Standard DSS）里面定义的数字签名算法（Digital Signature Algorithm DSA）。
*经过权威机构证实，sha-1加密算法的不安全性越来越高，sha-1指纹造假成本越来越低，随即微软、谷歌等IT巨头相继发布弃用sha-1加密算法声明，第三方认证机构自2016年1月1日起，将全面停止签发sha-1算法的数字证书。这一切表明都表明从1995年诞生至今的SHA1算法将被sha-256所取代。*

* RSA
一种公钥加密算法（非对称加密算法）。命名取自3个开发者姓名的首字母。
RSA算法基于一个十分简单的数论事实：将两个大质数相乘十分容易，但是想要对其乘积进行因式分解却极其困难，因此可以将乘积公开作为加密密钥。


# 制作公钥和密钥
```
cd /Users/woojean/projects/demo
ssh-keygen -t rsa -C "woojean.com"
```
输出：
```
Generating public/private rsa key pair.
Enter file in which to save the key (/Users/woojean/.ssh/id_rsa): ./xml_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in ./xml_rsa.
Your public key has been saved in ./xml_rsa.pub.
The key fingerprint is:
SHA256:XD6UWn7yIkBWhKB5vgAyXOhAcv+H16OPb/eT+mTNEGA woojean.com
The key's randomart image is:
+---[RSA 2048]----+
|o.o... oo   E    |
|+o.+  ..   o .   |
|*.o o o   =   .  |
|.+ o + o O     . |
|  . . + S B . .  |
|   . . + . *   + |
|    .   o . . o.o|
|         +...oo  |
|        .oo..+o. |
+----[SHA256]-----+
```
此时将在当前目录下找到私钥和公钥两个文件：xml_rsa、xml_rsa.pub。
导出pem格式的公钥证书文件：
```
ssh-keygen -f xml_rsa.pub -e -m PEM >> xml_public.pem
```
xml_rsa.pub的内容为：
```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDNG1FHdUjQ8zRhbXoj5wcrVmVpxm9MPOQbkl4cTEV1ckt2CCZcvFPLYcxm+dArL9frSBIQmP0m2S1NKbN6a4Z+uNvu/8fLrrgRkP+0Ki/kMs+c1sQu1teuBqtazSk2RalDj1dAVYOI/pWRxgYQk/FFkhyhLrEpeRDDkmBuiqAzM4qqPMk05k+xwR28bbMpy2rZznJrwEHrPs7SKK2OpNqNbmLxnoW9pFD/XhvI/SWWeptR1KU1m0jqdXjvoWPmUM5cgRlCaKcgJcMEVwk4hII/+PvmB3L3g3dqwCqT6l9m4ibbtW25PbspPfFrrEtK7Sk1zbGF1s/Bs/tknpgHvmYv woojean.com
```
xml_public.pem的内容为：
```
-----BEGIN RSA PUBLIC KEY-----
MIIBCgKCAQEAzRtRR3VI0PM0YW16I+cHK1ZlacZvTDzkG5JeHExFdXJLdggmXLxT
y2HMZvnQKy/X60gSEJj9JtktTSmzemuGfrjb7v/Hy664EZD/tCov5DLPnNbELtbX
rgarWs0pNkWpQ49XQFWDiP6VkcYGEJPxRZIcoS6xKXkQw5JgboqgMzOKqjzJNOZP
scEdvG2zKctq2c5ya8BB6z7O0iitjqTajW5i8Z6FvaRQ/14byP0llnqbUdSlNZtI
6nV476Fj5lDOXIEZQminICXDBFcJOISCP/j75gdy94N3asAqk+pfZuIm27VtuT27
KT3xa6xLSu0pNc2xhdbPwbP7ZJ6YB75mLwIDAQAB
-----END RSA PUBLIC KEY-----

```



# 准备xml报文
待加密的xml内容如下：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<RootInfo>
  <NS:Item type="1" xmlns:NS="http://www.woojean.com/">
    <NS:id>01</NS:id>
    <name>woojean</name>
  </NS:Item>
</RootInfo>
```

# 加密
## 







































